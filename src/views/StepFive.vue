<template>
  <div class="step-five-container">
    <!-- å¯¹è¯è½®æ¬¡é™åˆ¶æç¤º -->
    <div
      v-if="conversationCount >= 4"
      class="conversation-limit-warning"
      :class="{ 'warning-visible': showConversationWarning }"
    >
      <div class="warning-content">
        <div class="warning-icon">âš ï¸</div>
        <div class="warning-text">
          <span v-if="conversationCount === 4">æ‚¨å·²ç»è¿›è¡Œäº†4è½®å¯¹è¯ï¼Œè¿˜æœ‰1æ¬¡æäº¤æœºä¼š</span>
          <span v-else>æ‚¨å·²è¾¾åˆ°æœ€å¤§å¯¹è¯æ¬¡æ•°ï¼ˆ5è½®ï¼‰ï¼Œè¯·ç‚¹å‡»"ç»§ç»­ä¸‹ä¸€æ­¥"æŒ‰é’®è¿›å…¥ä¸‹ä¸€é˜¶æ®µ</span>
        </div>
      </div>
    </div>

    <!-- å¯¹è¯æ»šåŠ¨åŒºåŸŸ -->
    <div class="chat-scroll-area" ref="chatScrollArea">
      <!-- ä¿¡æ¯å¡ç‰‡åŒºåŸŸ -->
      <div class="info-card-section">
        <div class="info-card" :class="{ 'card-visible': showInfoCard }">
          <div class="card-header">
            <div class="card-icon">ğŸš¨</div>
            <div class="card-title">
              çªå‘æƒ…å†µï¼ä»Šå¤©ä¸‹åˆæœ‰é‡è¦è€ƒè¯•ï¼Œå­¦ç”Ÿäººæ•°ä¸´æ—¶å¢åŠ 15äººï¼Œ
              ç°åœ¨æ•™å®¤é‡Œåæ»¡äº†60ä¸ªå­¦ç”Ÿï¼Œè€Œä¸”å®¤å¤–æ°”æ¸©è¾¾åˆ°äº†37â„ƒã€‚
              è¿™ç§æç«¯æƒ…å†µä¸‹ï¼ŒåŸæœ‰çš„é€šé£èŠ‚èƒ½æ–¹æ¡ˆè¿˜é€‚ç”¨å—ï¼Ÿ
            </div>
          </div>

          <div class="card-content">
            <div class="chart-section">
              <h4>âš ï¸ åº”æ€¥çŠ¶æ€ç›‘æµ‹æ•°æ®ï¼š</h4>
              <div class="chart-container">
                <!-- äººæ•°å¯†åº¦å¯¹æ¯”å›¾ -->
                <div class="density-comparison">
                  <h5>ğŸ’¥ äººæ•°å¯†åº¦å˜åŒ–</h5>
                  <div class="comparison-bars">
                    <div class="bar-group">
                      <div class="bar-label">å¹³æ—¶</div>
                      <div class="bar normal">
                        <div class="bar-fill" style="height: 67%"></div>
                        <span class="bar-value">40äºº</span>
                      </div>
                      <div class="bar-note">0.67äºº/ã¡</div>
                    </div>
                    <div class="bar-group">
                      <div class="bar-label">è€ƒè¯•æ—¶</div>
                      <div class="bar emergency">
                        <div class="bar-fill" style="height: 100%"></div>
                        <span class="bar-value">60äºº</span>
                      </div>
                      <div class="bar-note critical">1.0äºº/ã¡</div>
                    </div>
                  </div>
                  <div class="impact-note">ğŸ’¥ äº§çƒ­é‡å¢åŠ ï¼š4000W â†’ 6000W (+50%)</div>
                </div>

                <!-- åº”æ€¥çŠ¶æ€é¢æ¿ -->
                <div class="emergency-status">
                  <h5>ğŸ”¥ æç«¯æ¡ä»¶è­¦æŠ¥</h5>
                  <div class="status-grid">
                    <div class="status-item critical">
                      <span class="status-icon">ğŸ‘¥</span>
                      <div class="status-info">
                        <span class="status-value">60äºº</span>
                        <span class="status-label">å­¦ç”Ÿæ€»æ•°</span>
                        <span class="status-alert">+15äºº</span>
                      </div>
                    </div>
                    <div class="status-item critical">
                      <span class="status-icon">ğŸŒ¡ï¸</span>
                      <div class="status-info">
                        <span class="status-value">37â„ƒ</span>
                        <span class="status-label">å®¤å¤–æ¸©åº¦</span>
                        <span class="status-alert">+2â„ƒ</span>
                      </div>
                    </div>
                    <div class="status-item warning">
                      <span class="status-icon">ğŸ”¥</span>
                      <div class="status-info">
                        <span class="status-value">6000W</span>
                        <span class="status-label">äººä½“äº§çƒ­</span>
                        <span class="status-alert">+50%</span>
                      </div>
                    </div>
                    <div class="status-item critical">
                      <span class="status-icon">ğŸ“</span>
                      <div class="status-info">
                        <span class="status-value">1.0äºº/ã¡</span>
                        <span class="status-label">äººæ•°å¯†åº¦</span>
                        <span class="status-alert">è¶…æ ‡</span>
                      </div>
                    </div>
                    <div class="status-item warning">
                      <span class="status-icon">â±ï¸</span>
                      <div class="status-info">
                        <span class="status-value">2å°æ—¶</span>
                        <span class="status-label">è€ƒè¯•æ—¶é•¿</span>
                        <span class="status-alert">æŒç»­</span>
                      </div>
                    </div>
                    <div class="status-item">
                      <span class="status-icon">ğŸ’¨</span>
                      <div class="status-info">
                        <span class="status-value">1.8m/s</span>
                        <span class="status-label">å®¤å¤–é£é€Ÿ</span>
                        <span class="status-alert">å‡å¼±</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å¯¹è¯æ¶ˆæ¯åŒºåŸŸ -->
      <div class="chat-messages">
        <!-- åˆå§‹ AI å¼•å¯¼æ¶ˆæ¯ -->
        <div class="message ai" v-if="showPrompt">
          <div class="message-avatar">ğŸ¤–</div>
          <div class="message-content">
            <div class="message-text">
              <strong>æƒ…å¢ƒå˜åŒ–é˜¶æ®µï¼š</strong>é¢å¯¹è¿™ç§çªå‘çš„æç«¯æƒ…å†µï¼Œä½ è§‰å¾—åº”è¯¥è§¦å‘ä»€ä¹ˆ"åº”æ€¥æ¨¡å¼"ï¼Ÿ
              <br /><br />
              è€ƒè™‘ä¸€ä¸‹ï¼š60äºº + 37â„ƒé«˜æ¸© + è€ƒè¯•ç¯å¢ƒï¼ŒåŸæ¥çš„æ–¹æ¡ˆè¿˜å¤Ÿç”¨å—ï¼Ÿéœ€è¦ä»€ä¹ˆç‰¹æ®Šæªæ–½ï¼Ÿ
            </div>
          </div>
        </div>

        <!-- åŠ¨æ€å¯¹è¯æ¶ˆæ¯ -->
        <div v-for="message in messages" :key="message.id" :class="['message', message.type]">
          <div class="message-avatar">
            {{ message.type === 'ai' ? 'ğŸ¤–' : 'ğŸ‘¤' }}
          </div>
          <div class="message-content">
            <div class="message-text" v-html="message.content"></div>
            <div class="message-time">
              {{ formatTime(message.timestamp) }}
            </div>
          </div>
        </div>

        <!-- AIæ€è€ƒåŠ è½½åŠ¨ç”» -->
        <div v-if="isGenerating" class="message ai loading-message">
          <div class="message-avatar">ğŸ¤–</div>
          <div class="message-content loading-content">
            <div class="loading-animation">
              <div class="loading-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
              </div>
              <div class="loading-text">AIæ­£åœ¨åˆ†æåº”æ€¥æ–¹æ¡ˆï¼Œé¢„è®¡éœ€è¦15-30ç§’...</div>
              <div class="loading-progress">
                <div class="progress-bar">
                  <div class="progress-fill"></div>
                </div>
                <div class="progress-steps">
                  <span class="step active">ğŸš¨ è¯„ä¼°é£é™©</span>
                  <span class="step" :class="{ active: loadingStep >= 2 }">âš¡ åº”æ€¥ç­–ç•¥</span>
                  <span class="step" :class="{ active: loadingStep >= 3 }">ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆ</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨ç”¨æˆ·è¾“å…¥åŒºåŸŸ -->
    <div class="input-section" :class="{ 'input-visible': showAnswerArea }">
      <div class="input-container">
        <textarea
          v-model="userAnswer"
          :placeholder="inputPlaceholder"
          class="user-input"
          :disabled="isGenerating || isConversationLimitReached"
          @input="handleInput"
          rows="3"
        ></textarea>
        <div class="input-toolbar">
          <button
            class="help-button"
            @click="requestHelp"
            :disabled="isGenerating || isConversationLimitReached || !canUseHelp"
            :title="getHelpButtonTitle"
          >
            <span class="help-icon">ğŸ’¬</span>
            æˆ‘æƒ³æé—®
            <!-- ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºå‰©ä½™æ¬¡æ•° -->
            <span v-if="canUseHelp" class="help-badge">
              {{ helpSystem.maxCycles - helpSystem.totalCycles }}
            </span>
          </button>
          <div class="action-buttons">
            <button
              v-if="!isConversationLimitReached"
              class="submit-button"
              @click="submitAnswer"
              :disabled="!canSubmit || isGenerating"
            >
              <span v-if="isGenerating">
                <span class="button-loading-dots">
                  <span class="button-dot"></span>
                  <span class="button-dot"></span>
                  <span class="button-dot"></span>
                </span>
                åˆ†æä¸­...
              </span>
              <span v-else>æäº¤</span>
            </button>
            <button
              class="next-button"
              @click="handleNextStep"
              v-if="answerSubmitted || isConversationLimitReached"
            >
              ä¸‹ä¸€æ­¥
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ğŸ”¥ æ–°å¢ï¼šå¸®åŠ©å¼¹çª— -->
    <div v-if="showHelpDialog" class="help-dialog-overlay" @click="closeHelpDialog">
      <div class="help-dialog" @click.stop>
        <div class="help-dialog-header">
          <div class="help-dialog-icon">ğŸ’¬</div>
          <h3>é€‰æ‹©å¸®åŠ©æ–¹å¼</h3>
          <button class="close-button" @click="closeHelpDialog">âœ•</button>
        </div>

        <div class="help-dialog-content">
          <p class="help-dialog-description">è¯·é€‰æ‹©ä½ éœ€è¦çš„å¸®åŠ©ç±»å‹ï¼š</p>

          <!-- å¸®åŠ©é€‰é¡¹ -->
          <div class="help-options">
            <!-- é€‰é¡¹1ï¼šå®Œå–„å†…å®¹ -->
            <button
              class="help-option"
              :class="{
                active: helpMode === 'refine',
                disabled: !availableHelpModes.refine,
              }"
              @click="selectHelpMode('refine')"
              :disabled="!userAnswer.trim() || !availableHelpModes.refine"
            >
              <div class="option-icon">ğŸ—£</div>
              <div class="option-content">
                <div class="option-title">
                  å¸®æˆ‘å®Œå–„å†…å®¹
                  <span v-if="!availableHelpModes.refine" class="used-badge">å·²ä½¿ç”¨</span>
                </div>
                <div class="option-description">
                  "æˆ‘å¥½åƒå†™å¾—ä¸å¤ªæ¸…æ¥šï¼Œå¸®æˆ‘å®Œå–„ä¸€ä¸‹å§ã€‚"ï¼ˆè¯·å…ˆåœ¨è¾“å…¥æ¡†ä¸­å†™ä¸‹ç­”æ¡ˆï¼Œå†ç‚¹å‡»è¯¥æŒ‰é’®ï¼‰
                </div>
              </div>
              <div class="option-arrow">â†’</div>
            </button>

            <!-- é€‰é¡¹2ï¼šç»™ç¤ºä¾‹ -->
            <button
              class="help-option"
              :class="{
                active: helpMode === 'example',
                disabled: !availableHelpModes.example,
              }"
              @click="selectHelpMode('example')"
              :disabled="!availableHelpModes.example"
            >
              <div class="option-icon">ğŸ’¡</div>
              <div class="option-content">
                <div class="option-title">
                  ç»™æˆ‘çœ‹çœ‹ä¾‹å­
                  <span v-if="!availableHelpModes.example" class="used-badge">å·²ä½¿ç”¨</span>
                </div>
                <div class="option-description">"æˆ‘æœ‰ç‚¹ä¸ç¡®å®šæ€ä¹ˆåšï¼Œèƒ½ç»™ä¸ªå‚è€ƒä¾‹å­å—ï¼Ÿ"</div>
              </div>
              <div class="option-arrow">â†’</div>
            </button>

            <!-- é€‰é¡¹3ï¼šè‡ªå®šä¹‰æé—® -->
            <button
              class="help-option"
              :class="{
                active: helpMode === 'custom',
                disabled: !availableHelpModes.custom,
              }"
              @click="selectHelpMode('custom')"
              :disabled="!availableHelpModes.custom"
            >
              <div class="option-icon">âœï¸</div>
              <div class="option-content">
                <div class="option-title">
                  æˆ‘æƒ³è‡ªå·±æé—®
                  <span v-if="!availableHelpModes.custom" class="used-badge">å·²ä½¿ç”¨</span>
                </div>
                <div class="option-description">"æˆ‘æœ‰å…·ä½“çš„é—®é¢˜æƒ³é—®ã€‚"</div>
              </div>
              <div class="option-arrow">â†’</div>
            </button>
          </div>

          <!-- ğŸ”¥ å‘¨æœŸæç¤º -->
          <div class="help-cycle-info">
            <span class="cycle-icon">ğŸ”„</span>
            <span>å‰©ä½™å¸®åŠ©æ¬¡æ•°ï¼š{{ helpSystem.maxCycles - helpSystem.totalCycles }} æ¬¡</span>
            <span v-if="helpSystem.isInCycle" class="cycle-tip">
              ï¼ˆå½“å‰å‘¨æœŸå·²ä½¿ç”¨
              {{ Object.values(helpSystem.currentCycleUsed).filter(Boolean).length }}/3ï¼‰
            </span>
          </div>

          <!-- è‡ªå®šä¹‰é—®é¢˜è¾“å…¥æ¡† -->
          <div v-if="helpMode === 'custom'" class="custom-question-section">
            <textarea
              v-model="customQuestion"
              placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜..."
              class="custom-question-input"
              rows="3"
              autofocus
            ></textarea>
            <div class="custom-question-actions">
              <button class="cancel-custom-button" @click="helpMode = null">å–æ¶ˆ</button>
              <button
                class="submit-custom-button"
                @click="submitCustomQuestion"
                :disabled="!customQuestion.trim()"
              >
                æäº¤é—®é¢˜
              </button>
            </div>
          </div>

          <!-- å®Œå–„å†…å®¹æç¤º -->
          <div v-if="helpMode === 'refine' && !userAnswer.trim()" class="help-tip">
            <span class="tip-icon">ğŸ’¡</span>
            <span>è¯·å…ˆåœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å†™ä¸€äº›å†…å®¹ï¼Œç„¶åæˆ‘å¯ä»¥å¸®ä½ å®Œå–„ã€‚</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ğŸ”¥ æ–°å¢ï¼šå¸®åŠ©æ¬¡æ•°ç”¨å°½æç¤º -->
    <div v-if="showHelpLimitDialog" class="help-dialog-overlay" @click="closeHelpLimitDialog">
      <div class="help-limit-dialog" @click.stop>
        <div class="limit-dialog-icon">âš ï¸</div>
        <h3>å¸®åŠ©æ¬¡æ•°å·²ç”¨å®Œ</h3>
        <p>æ‚¨å·²ä½¿ç”¨å®Œæ‰€æœ‰çš„å¸®åŠ©æ¬¡æ•°ï¼ˆ{{ helpSystem.maxCycles }} æ¬¡ï¼‰ã€‚</p>
        <p class="limit-tip">è¯·ç»§ç»­ç‹¬ç«‹å®Œæˆå‰©ä½™çš„ä»»åŠ¡ï¼Œæˆ–ç‚¹å‡»"æäº¤"æŒ‰é’®æäº¤æ‚¨çš„åº”æ€¥ç­–ç•¥ã€‚</p>
        <button class="limit-confirm-button" @click="closeHelpLimitDialog">çŸ¥é“äº†</button>
      </div>
    </div>

    <!-- ğŸ”¥ æ–°å¢ï¼šå‘¨æœŸå†…å¸®åŠ©å·²ç”¨å°½æç¤º -->
    <div v-if="showCycleLimitDialog" class="help-dialog-overlay" @click="closeCycleLimitDialog">
      <div class="help-limit-dialog" @click.stop>
        <div class="limit-dialog-icon">ğŸ”„</div>
        <h3>å½“å‰å‘¨æœŸçš„å¸®åŠ©å·²å…¨éƒ¨ä½¿ç”¨</h3>
        <p>æ‚¨å·²ä½¿ç”¨å®Œå½“å‰å‘¨æœŸçš„3ç§å¸®åŠ©æ–¹å¼ã€‚</p>
        <p class="limit-tip">
          è¯·å…ˆæäº¤æ‚¨çš„åº”æ€¥ç­–ç•¥ï¼Œæäº¤åå°†å¼€å¯æ–°çš„å¸®åŠ©å‘¨æœŸã€‚
          <br />
          å‰©ä½™å¸®åŠ©å‘¨æœŸï¼š<strong>{{ helpSystem.maxCycles - helpSystem.totalCycles }}</strong> æ¬¡
        </p>
        <button class="limit-confirm-button" @click="closeCycleLimitDialog">çŸ¥é“äº†</button>
      </div>
    </div>

    <!-- ğŸ”¥ ä¿®æ”¹ï¼šç¡®è®¤å¼¹çª— - ç»Ÿä¸€é£æ ¼ç‰ˆæœ¬ -->
    <div v-if="showConfirmDialog" class="confirm-dialog-overlay" @click="closeConfirmDialog">
      <div class="confirm-dialog" @click.stop>
        <div class="dialog-header">
          <div class="dialog-icon">ğŸ¯</div>
          <h3>ç¡®è®¤è¿›å…¥ä¸‹ä¸€æ­¥</h3>
        </div>
        <div class="dialog-content">
          <p>æ‚¨å³å°†å®Œæˆåº”æ€¥ç­–ç•¥åˆ†æé˜¶æ®µï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªå­¦ä¹ ç¯èŠ‚ã€‚è¯·ç¡®è®¤æˆ–ä¿®æ”¹æ‚¨çš„æœ€ç»ˆåº”æ€¥æ–¹æ¡ˆã€‚</p>

          <!-- å¯ç¼–è¾‘çš„å¿«ç…§åŒºåŸŸ -->
          <div v-if="editableFinalAnswer" class="answer-preview">
            <div class="preview-header">
              <span class="preview-icon">ğŸ“</span>
              <span class="preview-title">æœ¬æ­¥éª¤çš„æœ€ç»ˆå†…å®¹ï¼ˆå¯ç¼–è¾‘ï¼‰</span>
            </div>

            <!-- ğŸ”¥ æ–°å¢ï¼šä»»åŠ¡æ ‡é¢˜ -->
            <div class="task-title">
              <span class="task-icon">ğŸš¨</span>
              <span class="task-text">ä»»åŠ¡ï¼šåˆ¶å®šçªå‘æƒ…å†µä¸‹çš„åº”æ€¥é€šé£ç­–ç•¥ï¼ˆ60äºº+37â„ƒé«˜æ¸©åœºæ™¯ï¼‰</span>
            </div>

            <div class="preview-body">
              <textarea
                v-model="editableFinalAnswer"
                class="preview-textarea"
                rows="10"
                placeholder="è¯·è¾“å…¥æˆ–ä¿®æ”¹ä½ çš„æœ€ç»ˆåº”æ€¥æ–¹æ¡ˆ..."
              ></textarea>
              <p class="preview-hint">ğŸ’¡ è¿™æ˜¯æ‚¨æœ€åä¸€æ¬¡ä¿®æ”¹æœºä¼šï¼Œè¯·ä»”ç»†æ£€æŸ¥åç‚¹å‡»"ç¡®å®šç»§ç»­"ã€‚</p>
              <div class="char-count">å­—æ•°ï¼š{{ editableFinalAnswer.length }} å­—ç¬¦</div>
            </div>
          </div>

          <div class="completion-summary">
            <div class="summary-item">
              <span class="summary-icon">ğŸ’¬</span>
              <span>è¿›è¡Œäº† {{ conversationCount }} è½®åº”æ€¥ç­–ç•¥è®¨è®º</span>
            </div>
            <div class="summary-item" v-if="answerSubmitted">
              <span class="summary-icon">âœ…</span>
              <span>å·²æäº¤åº”æ€¥å¤„ç†æ–¹æ¡ˆ</span>
            </div>
            <div class="summary-item" v-if="isConversationLimitReached">
              <span class="summary-icon">â°</span>
              <span>å·²è¾¾åˆ°æœ€å¤§å¯¹è¯è½®æ¬¡é™åˆ¶</span>
            </div>
            <div class="summary-item" v-if="helpSystem.totalCycles > 0">
              <span class="summary-icon">ğŸ’¡</span>
              <span>ä½¿ç”¨äº† {{ helpSystem.totalCycles }} æ¬¡æ™ºèƒ½å¸®åŠ©</span>
            </div>
          </div>
          <div class="dialog-warning">
            <span class="warning-icon">âš ï¸</span>
            <span>è¿›å…¥ä¸‹ä¸€æ­¥åï¼Œæ‚¨å°†æ— æ³•è¿”å›ä¿®æ”¹å½“å‰çš„åº”æ€¥ç­–ç•¥ã€‚</span>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="cancel-button" @click="closeConfirmDialog">è¿”å›å¯¹è¯</button>
          <button
            class="confirm-button"
            @click="confirmNextStep"
            :disabled="!editableFinalAnswer.trim()"
          >
            ç¡®å®šç»§ç»­
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, nextTick, reactive, watch } from 'vue'
import { useRouter } from 'vue-router'
import { simpleStorage } from '../../api/utils/simpleStorage'
import { trackStep5Event } from '../../src/utils/tracking.ts'

// å®šä¹‰ç»„ä»¶é€šä¿¡
const emit = defineEmits(['update-progress', 'show-next-steps'])

const router = useRouter()

// ğŸ”¥ æ–°å¢ï¼šæœ€ç»ˆç­”æ¡ˆå¿«ç…§ç›¸å…³
const finalAnswerSnapshot = ref('') // æœ¬æ­¥æœ€ç»ˆç­”æ¡ˆå¿«ç…§
const finalAnswerConfirmed = ref(false) // æ˜¯å¦å·²ç¡®è®¤æœ€ç»ˆç­”æ¡ˆ
const editableFinalAnswer = ref('') // å¯ç¼–è¾‘çš„æœ€ç»ˆç­”æ¡ˆï¼ˆç”¨äºå¼¹çª—ä¸­ç¼–è¾‘ï¼‰

// ğŸ”¥ å®šä¹‰æ¶ˆæ¯ç±»å‹
interface Message {
  id?: string
  type: 'user' | 'ai' | 'system'
  content: string
  step: number
  stage?: number
  timestamp: string | Date
}

// ğŸ”¥ å®šä¹‰å­˜å‚¨çš„æ¶ˆæ¯ç±»å‹
interface StoredMessage {
  id: string
  type: 'user' | 'ai' | 'system'
  content: string
  timestamp: string
  stage?: number
  step?: number
}

// ğŸ”¥ å®šä¹‰ Step5 æ•°æ®ç»“æ„
interface Step5Data {
  conversationCount: number
  stageCompletionStatus: boolean[]
  messages: StoredMessage[]
  currentStage: number
  isCompleted: boolean
  // ğŸ”¥ æ–°å¢ï¼šå¸®åŠ©ç³»ç»ŸçŠ¶æ€
  helpSystem?: {
    totalCycles: number
    maxCycles: number
    currentCycleUsed: {
      refine: boolean
      example: boolean
      custom: boolean
    }
    isInCycle: boolean
  }
  // ğŸ”¥ æ–°å¢ï¼šåº”æ€¥æ–¹æ¡ˆå…ƒæ•°æ®
  emergencyStrategyMetadata?: {
    mentionedFactors: string[]
    hasQuantitativeAnalysis: boolean
    hasCostBenefit: boolean
    submittedAt?: string
  }
}

// ğŸ”¥ å®šä¹‰ event_data çš„ç±»å‹
interface Step5EventData {
  helpMode?: 'refine' | 'example' | 'custom'
  customQuestion?: string
  actualRequest?: string
  helpCycle?: number
  remainingHelps?: number
  cycleUsedModes?: string
  strategyLength?: number
  mentionedFactors?: string
  hasEmergencyMeasures?: boolean
  hasCostAnalysis?: boolean
  currentInputLength?: number
  hasInput?: boolean
  conversationCount?: number
  isCompleted?: boolean
  totalConversations?: number
  helpUsed?: number
  hasHistory?: boolean
  conversationRound?: number
  [key: string]: string | number | boolean | undefined
}

// å®šä¹‰æ•°æ®åº“ä¿å­˜çš„æ•°æ®ç»“æ„
interface ConversationData {
  sessionId: string
  step: number
  stage: number
  userInput: string
  aiResponse: string
  conversationCount: number
  timestamp: Date
  context: string
  experimentId?: string
  studentName?: string
  event_name?: string
  event_data?: Step5EventData
}

// ğŸ”¥ æ–°å¢ï¼šå¸®åŠ©ç³»ç»ŸçŠ¶æ€ç®¡ç†
const helpSystem = reactive({
  totalCycles: 0,
  maxCycles: 4, // ğŸ”¥ ä¿æŒ4ä¸ªå‘¨æœŸ
  currentCycleUsed: {
    refine: false,
    example: false,
    custom: false,
  },
  isInCycle: false,
})

// ğŸ”¥ æ–°å¢ï¼šè®¡ç®—å±æ€§ - å¸®åŠ©åŠŸèƒ½æ˜¯å¦å¯ç”¨
const canUseHelp = computed(() => {
  return helpSystem.totalCycles < helpSystem.maxCycles
})

// ğŸ”¥ æ–°å¢ï¼šè®¡ç®—å±æ€§ - å½“å‰å‘¨æœŸå‰©ä½™å¯ç”¨æ¨¡å¼
const availableHelpModes = computed(() => {
  return {
    refine: !helpSystem.currentCycleUsed.refine,
    example: !helpSystem.currentCycleUsed.example,
    custom: !helpSystem.currentCycleUsed.custom,
  }
})

// ğŸ”¥ æ–°å¢ï¼šè®¡ç®—å±æ€§ - å½“å‰å‘¨æœŸæ˜¯å¦è¿˜æœ‰å¯ç”¨æ¨¡å¼
const hasAvailableModesInCycle = computed(() => {
  return Object.values(availableHelpModes.value).some((available) => available)
})

// ğŸ”¥ æ–°å¢ï¼šå¸®åŠ©æŒ‰é’® title è®¡ç®—å±æ€§
const getHelpButtonTitle = computed(() => {
  if (!canUseHelp.value) {
    return 'å·²è¾¾åˆ°å¸®åŠ©æ¬¡æ•°ä¸Šé™'
  }
  if (helpSystem.isInCycle && !hasAvailableModesInCycle.value) {
    return 'å½“å‰å‘¨æœŸçš„å¸®åŠ©å·²å…¨éƒ¨ä½¿ç”¨ï¼Œè¯·æäº¤ç­”æ¡ˆåå†ä½¿ç”¨'
  }
  return 'ç‚¹å‡»è·å–æ™ºèƒ½å¸®åŠ©'
})

// ğŸ”¥ æ–°å¢ï¼šå¸®åŠ©å¼¹çª—ç›¸å…³çŠ¶æ€
const showHelpDialog = ref(false)
const helpMode = ref<'refine' | 'example' | 'custom' | null>(null)
const customQuestion = ref('')
const showHelpLimitDialog = ref(false)
const showCycleLimitDialog = ref(false)

// çŠ¶æ€ç®¡ç†
const showInfoCard = ref(false)
const showPrompt = ref(false)
const showAnswerArea = ref(false)
const showConversationWarning = ref(false)
const showConfirmDialog = ref(false)
const userAnswer = ref('')
const answerSubmitted = ref(false)
const isGenerating = ref(false)
const loadingStep = ref(1)

// å¯¹è¯è½®æ¬¡æ§åˆ¶
const conversationCount = ref(0)
const MAX_CONVERSATIONS = 5

// å¯¹è¯è½®æ¬¡è¿½è¸ª
const conversationRound = ref(0)

// å¯¹è¯å†å²å­˜å‚¨ä¸º Message æ•°ç»„
const messages = ref<Message[]>([])
const conversationHistory = ref<Message[]>([])

// æ»šåŠ¨å®¹å™¨å¼•ç”¨
const chatScrollArea = ref<HTMLElement | null>(null)

// è®¡ç®—å±æ€§
const canSubmit = computed(() => userAnswer.value.trim().length > 0)

const isConversationLimitReached = computed(() => conversationCount.value >= MAX_CONVERSATIONS)

const inputPlaceholder = computed(() => {
  if (isConversationLimitReached.value) {
    return 'å·²è¾¾åˆ°æœ€å¤§å¯¹è¯è½®æ¬¡ï¼Œè¯·ç‚¹å‡»"ç»§ç»­ä¸‹ä¸€æ­¥"è¿›å…¥ä¸‹ä¸€é˜¶æ®µ'
  }
  return 'åˆ†æè¿™ç§æç«¯æƒ…å†µéœ€è¦ä»€ä¹ˆåº”æ€¥æªæ–½......'
})

// ğŸ”¥ ç›‘å¬å¯¹è¯è½®æ¬¡å˜åŒ–ï¼ˆæ·»åŠ åŸ‹ç‚¹ï¼‰
watch(conversationCount, async (newCount) => {
  if (newCount >= 4) {
    showConversationWarning.value = true
    nextTick(() => {
      if (chatScrollArea.value) {
        chatScrollArea.value.scrollTo({
          top: 0,
          behavior: 'smooth',
        })
      }
    })
  }

  // ğŸ”¥ åŸ‹ç‚¹ - è¾¾åˆ°å¯¹è¯ä¸Šé™
  if (newCount === MAX_CONVERSATIONS) {
    await trackStep5Event('step5_conversation_limit_reached', getSessionId(), newCount, {
      isCompleted: answerSubmitted.value,
      helpUsed: helpSystem.totalCycles,
    })
  }
})

// ğŸ”¥ ä»æœ¬åœ°å­˜å‚¨æ¢å¤æ•°æ®
const restoreFromStorage = () => {
  const stepData = simpleStorage.getStepData(5) as Step5Data | null
  if (stepData) {
    conversationCount.value = stepData.conversationCount || 0
    answerSubmitted.value = stepData.stageCompletionStatus?.[0] || false

    messages.value = stepData.messages.map(
      (msg: StoredMessage): Message => ({
        id: msg.id,
        type: msg.type,
        content: msg.content,
        step: msg.step || 5,
        stage: msg.stage,
        timestamp: msg.timestamp,
      }),
    )

    conversationHistory.value = messages.value.filter((msg) => msg.type !== 'system')
    conversationRound.value = conversationCount.value

    // ğŸ”¥ æ¢å¤å¸®åŠ©ç³»ç»ŸçŠ¶æ€
    if (stepData.helpSystem) {
      Object.assign(helpSystem, stepData.helpSystem)
    }

    console.log('ğŸ’¾ Step5 - ä»å­˜å‚¨æ¢å¤æ•°æ®:', {
      conversationCount: conversationCount.value,
      messagesCount: messages.value.length,
      historyCount: conversationHistory.value.length,
      helpSystem: helpSystem,
    })
  }
}

// ğŸ”¥ ä¿å­˜å½“å‰çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
const saveToStorage = () => {
  const stepData = {
    conversationCount: conversationCount.value,
    stageCompletionStatus: [answerSubmitted.value, false, false],
    messages: messages.value.map(
      (msg): StoredMessage => ({
        id: msg.id || `msg_${Date.now()}`,
        type: msg.type,
        content: msg.content,
        timestamp: typeof msg.timestamp === 'string' ? msg.timestamp : msg.timestamp.toISOString(),
        step: 5,
        stage: 1,
      }),
    ),
    currentStage: 1,
    isCompleted: answerSubmitted.value,
    helpSystem: {
      totalCycles: helpSystem.totalCycles,
      maxCycles: helpSystem.maxCycles,
      currentCycleUsed: { ...helpSystem.currentCycleUsed },
      isInCycle: helpSystem.isInCycle,
    },
    emergencyStrategyMetadata: extractEmergencyMetadata(),
    // ğŸ”¥ æ–°å¢ï¼šå¿«ç…§å­—æ®µ
    finalAnswerSnapshot: finalAnswerSnapshot.value,
    finalAnswerConfirmed: finalAnswerConfirmed.value,
  }

  simpleStorage.saveStepData(5, stepData)

  console.log('ğŸ’¾ Step5 - ä¿å­˜æ•°æ®åˆ°å­˜å‚¨:', {
    conversationCount: stepData.conversationCount,
    messagesCount: stepData.messages.length,
    helpSystem: stepData.helpSystem,
  })
}

// ğŸ”¥ æ–°å¢ï¼šä¿å­˜å¸®åŠ©ç³»ç»ŸçŠ¶æ€åˆ° localStorage
function saveHelpSystemState() {
  const stepData = simpleStorage.getStepData(5) as Step5Data | null
  if (stepData) {
    stepData.helpSystem = {
      totalCycles: helpSystem.totalCycles,
      maxCycles: helpSystem.maxCycles,
      currentCycleUsed: { ...helpSystem.currentCycleUsed },
      isInCycle: helpSystem.isInCycle,
    }
    stepData.emergencyStrategyMetadata = extractEmergencyMetadata()
    localStorage.setItem('step5_data', JSON.stringify(stepData))
    console.log('ğŸ’¾ Step5 å¸®åŠ©ç³»ç»ŸçŠ¶æ€å·²ä¿å­˜')
  }
}

// ğŸ”¥ ä¿®æ”¹ï¼šç”Ÿæˆåº”æ€¥æ–¹æ¡ˆå¿«ç…§ - å»æ‰markdownæ ¼å¼
const generateEmergencySnapshot = (): string => {
  const userMessages = messages.value.filter((msg) => msg.type === 'user').map((msg) => msg.content)

  if (userMessages.length === 0) {
    return 'ï¼ˆå°šæœªæäº¤åº”æ€¥æ–¹æ¡ˆå†…å®¹ï¼‰'
  }

  const validMessages = userMessages.filter((content) => content.trim().length > 20)

  if (validMessages.length === 0) {
    return 'ï¼ˆå°šæœªæäº¤æœ‰æ•ˆçš„åº”æ€¥æ–¹æ¡ˆå†…å®¹ï¼‰'
  }

  // ğŸ”¥ ç®€åŒ–æ ¼å¼ï¼Œå»æ‰markdown
  return validMessages.join('\n\n')
}

// ğŸ”¥ æ–°å¢ï¼šæå–åº”æ€¥æ–¹æ¡ˆå…ƒæ•°æ®
function extractEmergencyMetadata() {
  const allUserInputs = messages.value
    .filter((m) => m.type === 'user')
    .map((m) => m.content)
    .join(' ')

  return {
    mentionedFactors: detectMentionedFactors(allUserInputs),
    hasQuantitativeAnalysis: /\d+/.test(allUserInputs),
    hasCostBenefit: /(æˆæœ¬|è´¹ç”¨|èƒ½è€—)/.test(allUserInputs),
    submittedAt: answerSubmitted.value ? new Date().toISOString() : undefined,
  }
}

// ğŸ”¥ æ–°å¢ï¼šæ£€æµ‹æåˆ°çš„åº”æ€¥è¦ç´ 
function detectMentionedFactors(text: string): string[] {
  const factors = []
  if (/(äººæ•°|60äºº|å­¦ç”Ÿ)/.test(text)) factors.push('äººæ•°')
  if (/(æ¸©åº¦|37|é«˜æ¸©|ç‚çƒ­)/.test(text)) factors.push('æ¸©åº¦')
  if (/(é€šé£|å¼€çª—|æ’é£)/.test(text)) factors.push('é€šé£')
  if (/(ç©ºè°ƒ|åˆ¶å†·|é™æ¸©)/.test(text)) factors.push('ç©ºè°ƒ')
  if (/(æ—¶é—´|2å°æ—¶|è€ƒè¯•)/.test(text)) factors.push('æ—¶é•¿')
  if (/(é¢„å†·|æå‰)/.test(text)) factors.push('é¢„å†·')
  if (/(åˆ†æµ|åˆ†æ‰¹)/.test(text)) factors.push('äººå‘˜ç®¡ç†')
  return factors
}

// æ–¹æ³•
const handleInput = () => {
  // è¾“å…¥å¤„ç†
}

// ğŸ”¥ ä¿®æ”¹ï¼šæäº¤ç­”æ¡ˆå‡½æ•°ï¼ˆæ·»åŠ å‘¨æœŸé‡ç½®å’ŒåŸ‹ç‚¹ï¼‰
const submitAnswer = async () => {
  if (!canSubmit.value || isConversationLimitReached.value) return

  conversationCount.value += 1
  conversationRound.value = conversationCount.value

  addMessage('user', userAnswer.value)

  const currentAnswer = userAnswer.value
  userAnswer.value = ''

  // ğŸ”¥ é‡ç½®å¸®åŠ©å‘¨æœŸ
  if (helpSystem.isInCycle) {
    console.log(`ğŸ”„ é‡ç½®å¸®åŠ©å‘¨æœŸï¼Œå·²ä½¿ç”¨å‘¨æœŸæ•°: ${helpSystem.totalCycles}`)
    helpSystem.isInCycle = false
    helpSystem.currentCycleUsed = {
      refine: false,
      example: false,
      custom: false,
    }
    saveHelpSystemState()
  }

  // ğŸ”¥ åŸ‹ç‚¹ - æäº¤åº”æ€¥æ–¹æ¡ˆ
  await trackStep5Event(
    'step5_emergency_strategy_submit',
    getSessionId(),
    conversationCount.value,
    {
      strategyLength: currentAnswer.length,
      mentionedFactors: detectMentionedFactors(currentAnswer).join(','),
      conversationRound: conversationRound.value,
    },
  )

  isGenerating.value = true
  loadingStep.value = 1

  const stepInterval = setInterval(() => {
    if (loadingStep.value < 3) {
      loadingStep.value++
    }
  }, 5000)

  try {
    const response = await callAIAPI(currentAnswer, conversationRound.value)
    clearInterval(stepInterval)

    addMessage('ai', response)

    answerSubmitted.value = true

    saveToStorage()

    emit('update-progress', 5)
    emit('show-next-steps')
  } catch (error) {
    clearInterval(stepInterval)
    console.error('âŒ Step5 - AI API è°ƒç”¨å¤±è´¥:', error)
    addMessage('ai', 'æŠ±æ­‰ï¼Œç³»ç»Ÿæš‚æ—¶æ— æ³•å¤„ç†æ‚¨çš„å›ç­”ï¼Œè¯·ç¨åé‡è¯•ã€‚')
    saveToStorage()
  } finally {
    isGenerating.value = false
    loadingStep.value = 1
  }
}

// ğŸ”¥ æ–°å¢ï¼šæ‰“å¼€å¸®åŠ©å¼¹çª—ï¼ˆæ·»åŠ åŸ‹ç‚¹å’Œå‘¨æœŸç®¡ç†ï¼‰
function requestHelp() {
  if (isGenerating.value || isConversationLimitReached.value) return

  // æ£€æŸ¥æ˜¯å¦è¿˜èƒ½ä½¿ç”¨å¸®åŠ©åŠŸèƒ½
  if (!canUseHelp.value) {
    showHelpLimitDialog.value = true
    return
  }

  // å¦‚æœä¸åœ¨å‘¨æœŸä¸­ï¼Œå¼€å¯æ–°å‘¨æœŸ
  if (!helpSystem.isInCycle) {
    helpSystem.totalCycles++
    helpSystem.isInCycle = true
    console.log(`ğŸ†• å¼€å¯ç¬¬ ${helpSystem.totalCycles} ä¸ªå¸®åŠ©å‘¨æœŸ`)
  }

  // æ£€æŸ¥å½“å‰å‘¨æœŸæ˜¯å¦è¿˜æœ‰å¯ç”¨æ¨¡å¼
  if (!hasAvailableModesInCycle.value) {
    showCycleLimitDialog.value = true
    return
  }

  // ğŸ”¥ åŸ‹ç‚¹ - ç‚¹å‡»å¸®åŠ©æŒ‰é’®
  trackStep5Event('step5_help_button_click', getSessionId(), conversationCount.value, {
    currentInputLength: userAnswer.value.length,
    hasInput: userAnswer.value.length > 0,
    helpCycle: helpSystem.totalCycles,
    availableModes: Object.entries(availableHelpModes.value)
      .filter(([_, available]) => available)
      .map(([mode]) => mode)
      .join(','),
  })

  showHelpDialog.value = true
}

// ğŸ”¥ æ–°å¢ï¼šå…³é—­å¸®åŠ©å¼¹çª—
function closeHelpDialog() {
  showHelpDialog.value = false
  helpMode.value = null
  customQuestion.value = ''
}

// ğŸ”¥ æ–°å¢ï¼šå…³é—­é™åˆ¶æç¤ºå¼¹çª—
const closeHelpLimitDialog = () => {
  showHelpLimitDialog.value = false
}

const closeCycleLimitDialog = () => {
  showCycleLimitDialog.value = false
}

// ğŸ”¥ æ–°å¢ï¼šé€‰æ‹©å¸®åŠ©æ¨¡å¼
function selectHelpMode(mode: 'refine' | 'example' | 'custom') {
  // æ£€æŸ¥è¯¥æ¨¡å¼åœ¨å½“å‰å‘¨æœŸæ˜¯å¦å·²ä½¿ç”¨
  if (!availableHelpModes.value[mode]) {
    console.log(`âŒ æ¨¡å¼ ${mode} åœ¨å½“å‰å‘¨æœŸå·²ä½¿ç”¨`)
    return
  }

  helpMode.value = mode

  // å¦‚æœä¸æ˜¯è‡ªå®šä¹‰æé—®ï¼Œç›´æ¥æ‰§è¡Œ
  if (mode !== 'custom') {
    executeHelp(mode)
  }
}

// ğŸ”¥ æ–°å¢ï¼šæäº¤è‡ªå®šä¹‰é—®é¢˜
function submitCustomQuestion() {
  if (!customQuestion.value.trim()) {
    return
  }
  executeHelp('custom', customQuestion.value)
}

// ğŸ”¥ æ–°å¢ï¼šæ‰§è¡Œå¸®åŠ©è¯·æ±‚ï¼ˆæ·»åŠ åŸ‹ç‚¹å’Œå‘¨æœŸç®¡ç†ï¼‰
async function executeHelp(mode: 'refine' | 'example' | 'custom', customQuestionText?: string) {
  // å…³é—­å¼¹çª—
  showHelpDialog.value = false

  // æ ‡è®°è¯¥æ¨¡å¼åœ¨å½“å‰å‘¨æœŸå·²ä½¿ç”¨
  helpSystem.currentCycleUsed[mode] = true

  // ä¿å­˜å¸®åŠ©ç³»ç»ŸçŠ¶æ€
  saveHelpSystemState()

  // æ ¹æ®å¸®åŠ©æ¨¡å¼ç”Ÿæˆå¯è¯»çš„ç”¨æˆ·æ¶ˆæ¯
  let userDisplayMessage = ''
  let helpRequestContent = ''
  let helpContextType = ''

  switch (mode) {
    case 'refine':
      userDisplayMessage = `ğŸ’¬ å¸®æˆ‘å®Œå–„å†…å®¹ï¼š${userAnswer.value || 'ï¼ˆå½“å‰è¾“å…¥å†…å®¹ï¼‰'}`
      helpRequestContent = '[REFINE_CONTENT]' + (userAnswer.value || 'å½“å‰è¾“å…¥å†…å®¹éœ€è¦å®Œå–„')
      helpContextType = 'refine_content'
      break
    case 'example':
      userDisplayMessage = 'ğŸ’¡ èƒ½ç»™æˆ‘çœ‹çœ‹ä¾‹å­å—ï¼Ÿ'
      helpRequestContent = '[REQUEST_EXAMPLE]' + 'éœ€è¦ä¸€ä¸ªå‚è€ƒç¤ºä¾‹'
      helpContextType = 'request_example'
      break
    case 'custom':
      userDisplayMessage = `âœï¸ æˆ‘æƒ³é—®ï¼š${customQuestionText || 'éœ€è¦å…·ä½“æŒ‡å¯¼'}`
      helpRequestContent = '[CUSTOM_QUESTION]' + (customQuestionText || 'éœ€è¦å…·ä½“æŒ‡å¯¼')
      helpContextType = 'custom_question'
      break
  }

  // 1. å…ˆæ˜¾ç¤ºç”¨æˆ·çš„å¸®åŠ©è¯·æ±‚æ¶ˆæ¯
  addMessage('user', userDisplayMessage)

  // å¢åŠ å¯¹è¯è®¡æ•°
  conversationCount.value += 1

  // ğŸ”¥ åŸ‹ç‚¹ - ä½¿ç”¨å¸®åŠ©
  await trackStep5Event('step5_help_request', getSessionId(), conversationCount.value, {
    helpMode: mode,
    helpCycle: helpSystem.totalCycles,
    cycleUsedModes: Object.entries(helpSystem.currentCycleUsed)
      .filter(([_, used]) => used)
      .map(([mode]) => mode)
      .join(','),
    remainingHelps: helpSystem.maxCycles - helpSystem.totalCycles,
  })

  isGenerating.value = true
  loadingStep.value = 1

  const stepInterval = setInterval(() => {
    if (loadingStep.value < 2) {
      loadingStep.value++
    }
  }, 2000)

  try {
    // 2. è°ƒç”¨ API
    const helpResponse = await callEnhancedHelpAPI(mode, customQuestionText, helpRequestContent)

    clearInterval(stepInterval)

    // 3. æ˜¾ç¤º AI å›å¤
    addMessage('ai', helpResponse)

    // 4. ä¿å­˜åˆ°æ•°æ®åº“
    await saveConversationToDB(
      userDisplayMessage,
      helpResponse,
      `emergency_strategy_${helpContextType}`,
      {
        helpMode: mode,
        customQuestion: mode === 'custom' ? customQuestionText : undefined,
        actualRequest: helpRequestContent,
      },
    )

    saveToStorage()
  } catch (error) {
    clearInterval(stepInterval)
    console.error('âŒ Step5 - è·å–å¸®åŠ©å¤±è´¥:', error)

    const fallbackTexts: Record<string, string> = {
      refine: 'è¯•ç€æŠŠä½ çš„åº”æ€¥æ–¹æ¡ˆæ›´å…·ä½“åœ°è¡¨è¾¾å‡ºæ¥ï¼Œæ¯”å¦‚å¯ä»¥åŠ ä¸Šå…·ä½“çš„æ•°å€¼æˆ–æ“ä½œæ­¥éª¤ã€‚',
      example: 'æƒ³æƒ³åœ¨è¿™ç§æç«¯æƒ…å†µä¸‹ï¼ˆ60äºº+37â„ƒï¼‰ï¼Œé€šå¸¸ä¼šé‡‡å–å“ªäº›åº”æ€¥æªæ–½ï¼Ÿ',
      custom: 'æ ¹æ®ä½ çš„é—®é¢˜ï¼Œå»ºè®®ä»åº”æ€¥é™æ¸©ã€äººå‘˜åˆ†æµã€é¢„å†·ç­–ç•¥ç­‰è§’åº¦æ¥æ€è€ƒã€‚',
    }

    addMessage('ai', fallbackTexts[mode] || fallbackTexts.custom)
    saveToStorage()
  } finally {
    isGenerating.value = false
    loadingStep.value = 1

    // é‡ç½®å¼¹çª—çŠ¶æ€
    helpMode.value = null
    customQuestion.value = ''
  }
}

// ğŸ”¥ æ–°å¢ï¼šè°ƒç”¨å¢å¼ºç‰ˆå¸®åŠ© API
async function callEnhancedHelpAPI(
  helpMode: 'refine' | 'example' | 'custom' = 'custom',
  customQuestionText?: string,
  helpRequestContent?: string,
): Promise<string> {
  try {
    // âœ… ä¿®å¤ï¼šé‡å‘½åå±€éƒ¨å˜é‡ï¼Œé¿å…ä¸ ref åŒå
    const formattedHistory = conversationHistory.value
      .filter((msg: Message) => msg.step === 5) // âœ… æ·»åŠ ç±»å‹æ³¨è§£
      .map((msg: Message) => ({
        // âœ… æ·»åŠ ç±»å‹æ³¨è§£
        type: msg.type,
        content: msg.content,
        step: msg.step,
        stage: msg.stage,
        timestamp: msg.timestamp,
      }))

    // å¦‚æœæ²¡æœ‰ä¼ å…¥ helpRequestContentï¼Œåˆ™ç”Ÿæˆ
    let actualHelpRequest = helpRequestContent
    if (!actualHelpRequest) {
      switch (helpMode) {
        case 'refine':
          actualHelpRequest = '[REFINE_CONTENT]' + (userAnswer.value || 'å½“å‰è¾“å…¥å†…å®¹éœ€è¦å®Œå–„')
          break
        case 'example':
          actualHelpRequest = '[REQUEST_EXAMPLE]' + 'éœ€è¦ä¸€ä¸ªå‚è€ƒç¤ºä¾‹'
          break
        case 'custom':
          actualHelpRequest = '[CUSTOM_QUESTION]' + (customQuestionText || 'éœ€è¦å…·ä½“æŒ‡å¯¼')
          break
      }
    }

    console.log('ğŸ“¤ Step5 æ™ºèƒ½å¸®åŠ© - å‘é€å¯¹è¯å†å²:', {
      count: formattedHistory.length,
      helpMode,
      history: formattedHistory,
    })

    const response = await fetch('/api/ai/analyze', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Experiment-ID': localStorage.getItem('experimentId') || '',
      },
      body: JSON.stringify({
        userAnswer: actualHelpRequest,
        context: {
          isHelpRequest: true,
          helpMode,
          customQuestion: customQuestionText,
          currentUserInput: userAnswer.value,
          recentQuestions: getRecentQuestions(),
          isExam: true,
          requireQuiet: true,
        },
        step: 5,
        stage: 1,
        sessionId: getSessionId(),
        conversationHistory: formattedHistory, // âœ… ä½¿ç”¨æ–°å˜é‡å
        followUpContext: {
          conversationCount: conversationCount.value,
          isSmartHintRequest: true,
          helpType:
            helpMode === 'refine'
              ? 'refine_content'
              : helpMode === 'example'
                ? 'request_example'
                : 'custom_question',
          needsGuidance: true,
          needsContinuity: true,
          emergencyContext: {
            studentCount: 60,
            temperature: 37,
            duration: '2å°æ—¶è€ƒè¯•',
            heatGeneration: '6000W',
            density: '1.0äºº/ã¡',
          },
        },
      }),
    })

    if (!response.ok) {
      throw new Error(`API Error: ${response.statusText}`)
    }

    const data = await response.json()

    console.log('ğŸ“¥ Step5 æ™ºèƒ½å¸®åŠ© - æ”¶åˆ°å“åº”:', {
      response: data.response,
      isSmartHint: data.metadata?.isSmartHint,
      helpMode,
    })

    return (
      data.response ||
      'ğŸ’¡ å¯ä»¥ä»è¿™å‡ ä¸ªè§’åº¦æ€è€ƒï¼š<br>â€¢ åº”æ€¥åˆ¶å†·æªæ–½<br>â€¢ äººå‘˜åˆ†æµç­–ç•¥<br>â€¢ ç´§æ€¥é€šé£æ–¹æ¡ˆ<br>â€¢ è€ƒè¯•ç¯å¢ƒä¿éšœ'
    )
  } catch (error) {
    console.error('âŒ Step5 - æ™ºèƒ½å¸®åŠ©APIè°ƒç”¨å¤±è´¥:', error)
    throw error
  }
}

// ğŸ”¥ ä¿®æ”¹ï¼šæ‰“å¼€ç¡®è®¤å¼¹çª— - åˆå§‹åŒ–å¯ç¼–è¾‘å†…å®¹
const handleNextStep = () => {
  // ç”Ÿæˆå¿«ç…§
  finalAnswerSnapshot.value = generateEmergencySnapshot()
  // åˆå§‹åŒ–å¯ç¼–è¾‘å†…å®¹ä¸ºå½“å‰å¿«ç…§
  editableFinalAnswer.value = finalAnswerSnapshot.value
  showConfirmDialog.value = true
}

const closeConfirmDialog = () => {
  showConfirmDialog.value = false
}

// ğŸ”¥ ä¿®æ”¹ï¼šç¡®è®¤è¿›å…¥ä¸‹ä¸€æ­¥ - ä¿å­˜ç¼–è¾‘åçš„å¿«ç…§
const confirmNextStep = async () => {
  // ä½¿ç”¨ç¼–è¾‘åçš„å†…å®¹ä½œä¸ºæœ€ç»ˆå¿«ç…§
  finalAnswerSnapshot.value = editableFinalAnswer.value.trim()
  finalAnswerConfirmed.value = true
  showConfirmDialog.value = false

  // 1. ä¿å­˜åˆ° localStorageï¼ˆStep6 ä¼šè¯»å–ï¼‰
  simpleStorage.setItem('step5_final_answer', {
    content: finalAnswerSnapshot.value,
    confirmedAt: new Date().toISOString(),
  })

  // 2. åŸ‹ç‚¹ - ç‚¹å‡»ç»§ç»­ä¸‹ä¸€æ­¥
  await trackStep5Event('step5_next_step_click', getSessionId(), conversationCount.value, {
    isCompleted: answerSubmitted.value,
    totalConversations: conversationCount.value,
    helpUsed: helpSystem.totalCycles,
    finalAnswerLength: finalAnswerSnapshot.value.length,
    wasEdited: editableFinalAnswer.value !== generateEmergencySnapshot(),
  })

  // 3. ä¿å­˜åˆ° storageï¼ˆåŒ…å«å¿«ç…§ï¼‰
  saveToStorage()

  // 4. è·³è½¬ä¸‹ä¸€æ­¥
  goToNextStep()
}

const goToNextStep = () => {
  simpleStorage.updateCurrentStep(6)
  saveProgressToLocal()
  router.push('/experiment/step6')
}

// addMessage å‡½æ•°ï¼Œæ·»åŠ  step
const addMessage = (type: 'ai' | 'user' | 'system', content: string) => {
  const messageId = `${type}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  const message: Message = {
    id: messageId,
    type,
    content,
    step: 5,
    stage: 1,
    timestamp: new Date(),
  }

  messages.value.push(message)

  if (type !== 'system') {
    conversationHistory.value.push(message)
  }

  simpleStorage.addMessage(5, type, content, 1)

  nextTick(() => {
    scrollToBottom()
  })
}

const scrollToBottom = () => {
  if (chatScrollArea.value) {
    chatScrollArea.value.scrollTop = chatScrollArea.value.scrollHeight
  }
}

const formatTime = (timestamp: Date | string) => {
  const date = typeof timestamp === 'string' ? new Date(timestamp) : timestamp
  return date.toLocaleTimeString('zh-CN', {
    hour: '2-digit',
    minute: '2-digit',
  })
}

const saveProgressToLocal = () => {
  const progressData = {
    conversationCount: conversationCount.value,
    answerSubmitted: answerSubmitted.value,
    messages: messages.value.map((msg) => ({
      id: msg.id,
      type: msg.type,
      content: msg.content,
      timestamp: typeof msg.timestamp === 'string' ? msg.timestamp : msg.timestamp.toISOString(),
    })),
    conversationHistory: conversationHistory.value.map((msg) => ({
      type: msg.type,
      content: msg.content,
      step: msg.step,
      stage: msg.stage,
      timestamp: msg.timestamp,
    })),
    completedAt: new Date().toISOString(),
  }

  localStorage.setItem('step5_progress', JSON.stringify(progressData))
}

// è·å–æœ€è¿‘é—®é¢˜ç”¨äºä¸Šä¸‹æ–‡
const getRecentQuestions = (): string => {
  return conversationHistory.value
    .filter((msg) => msg.type === 'ai')
    .slice(-3)
    .map((msg) => msg.content)
    .join('ï¼›')
}

// API è°ƒç”¨å‡½æ•°
const callAIAPI = async (answer: string, round: number): Promise<string> => {
  try {
    const sessionId = getSessionId()

    const formattedHistory = conversationHistory.value
      .filter((msg) => msg.step === 5)
      .map((msg) => ({
        type: msg.type,
        content: msg.content,
        step: msg.step,
        stage: msg.stage || 1,
        timestamp: msg.timestamp,
      }))

    console.log('ğŸ“¤ Step5 - å‘é€ç»™åç«¯çš„å¯¹è¯å†å²:', {
      count: formattedHistory.length,
      history: formattedHistory,
      userAnswer: answer.substring(0, 50) + (answer.length > 50 ? '...' : ''),
    })

    const response = await fetch('/api/ai/analyze', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Experiment-ID': localStorage.getItem('experimentId') || '',
      },
      body: JSON.stringify({
        userAnswer: answer,
        context: {
          recentQuestions: getRecentQuestions(),
          isExam: true,
          requireQuiet: true,
        },
        step: 5,
        stage: 1,
        sessionId: sessionId,
        conversationHistory: formattedHistory,
        followUpContext: {
          conversationRound: round,
          conversationCount: conversationCount.value,
          emergencyContext: {
            studentCount: 60,
            temperature: 37,
            duration: '2å°æ—¶è€ƒè¯•',
            heatGeneration: '6000W',
            density: '1.0äºº/ã¡',
          },
          needsContinuity: true,
        },
      }),
    })

    if (!response.ok) {
      throw new Error(`API Error: ${response.statusText}`)
    }

    const data = await response.json()

    console.log('ğŸ“¥ Step5 - æ”¶åˆ°åç«¯å“åº”:', {
      response: data.response?.substring(0, 100) + (data.response?.length > 100 ? '...' : ''),
      metadata: data.metadata,
    })

    const aiResponse = data.response || generateContextualResponse(answer, round)

    await saveConversationToDB(answer, aiResponse, 'emergency_strategy_development')

    return aiResponse
  } catch (error) {
    console.error('âŒ Step5 - AI API è°ƒç”¨å¤±è´¥:', error)
    const fallbackResponse = generateContextualResponse(answer, round)

    await saveConversationToDB(answer, fallbackResponse, 'emergency_strategy_fallback')

    return fallbackResponse
  }
}

// ç”Ÿæˆä¸Šä¸‹æ–‡ç›¸å…³çš„å›å¤
const generateContextualResponse = (answer: string, round: number): string => {
  const answerLower = answer.toLowerCase()
  const history = conversationHistory.value.map((msg) => msg.content)

  if (round === 1) {
    if (answerLower.includes('åº”æ€¥') || answerLower.includes('ç´§æ€¥')) {
      return `
        <div class="ai-response-structured">
          <div class="response-header">
            <span class="response-icon">ğŸš¨</span>
            <strong>åº”æ€¥æ¨¡å¼åˆ†æ</strong>
          </div>

          <div class="analysis-section">
            <h4>ğŸ¯ åº”æ€¥ç­–ç•¥è¦ç‚¹</h4>
            <ul class="analysis-list">
              <li><strong>ç«‹å³é™æ¸©ï¼š</strong>ç©ºè°ƒåŠŸç‡è°ƒè‡³æœ€å¤§ï¼Œæ¸©åº¦è®¾å®š22-24â„ƒ</li>
              <li><strong>å¼ºåˆ¶é€šé£ï¼š</strong>å¼€å¯æ‰€æœ‰å¯ç”¨é€šé£è®¾å¤‡</li>
              <li><strong>äººå‘˜ç®¡ç†ï¼š</strong>è€ƒè™‘åˆ†æ‰¹è€ƒè¯•æˆ–æ›´æ¢æ›´å¤§æ•™å®¤</li>
            </ul>
          </div>

          <div class="analysis-section">
            <h4>âš¡ èƒ½è€—ä¸æ•ˆæœå¹³è¡¡</h4>
            <ul class="challenge-list">
              <li><strong>èƒ½è€—æ¿€å¢ï¼š</strong>å¯èƒ½è¾¾åˆ°5-6kWï¼Œæ¯”å¹³æ—¶å¢åŠ 50%ä»¥ä¸Š</li>
              <li><strong>é™æ¸©é€Ÿåº¦ï¼š</strong>éœ€è¦15-20åˆ†é’Ÿè¾¾åˆ°ç›®æ ‡æ¸©åº¦</li>
              <li><strong>ç»´æŒæˆæœ¬ï¼š</strong>2å°æ—¶è€ƒè¯•æœŸé—´çš„é«˜åŠŸç‡è¿è¡Œ</li>
            </ul>
          </div>

          <div class="follow-up-question">
            <span class="question-icon">ğŸ¤”</span>
            <em>ä½ è§‰å¾—è¿™ç§åº”æ€¥æªæ–½åœ¨å®é™…æ‰§è¡Œä¸­ä¼šé‡åˆ°ä»€ä¹ˆå›°éš¾ï¼Ÿ</em>
          </div>
        </div>
      `
    } else if (answerLower.includes('ç©ºè°ƒ') || answerLower.includes('åˆ¶å†·')) {
      return `
        <div class="ai-response-structured">
          <div class="response-header">
            <span class="response-icon">â„ï¸</span>
            <strong>æé™åˆ¶å†·æ–¹æ¡ˆ</strong>
          </div>

          <div class="analysis-section">
            <h4>ğŸ”¥ æŒ‘æˆ˜åˆ†æ</h4>
            <p>60äººäº§ç”Ÿ6000Wçƒ­é‡ï¼Œç›¸å½“äº1.9å€åŸæœ‰ç©ºè°ƒåŠŸç‡ï¼</p>
            <ul class="analysis-list">
              <li><strong>åˆ¶å†·è´Ÿè·ï¼š</strong>6000Wäººä½“çƒ­ + å¤–ç•Œ37â„ƒçƒ­ä¼ å¯¼</li>
              <li><strong>è®¾å¤‡èƒ½åŠ›ï¼š</strong>ç°æœ‰3.2kWç©ºè°ƒå¯èƒ½æ— æ³•åº”å¯¹</li>
              <li><strong>æ—¶é—´è¦æ±‚ï¼š</strong>å¿…é¡»åœ¨è€ƒè¯•å¼€å§‹å‰è¾¾åˆ°èˆ’é€‚æ¸©åº¦</li>
            </ul>
          </div>

          <div class="challenge-section">
            <h4>ğŸ’¡ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ</h4>
            <p>ä½ æœ‰æ²¡æœ‰è€ƒè™‘è¿‡<strong>é¢„å†·ç­–ç•¥</strong>ï¼Ÿæ¯”å¦‚æå‰2å°æ—¶å¼€å§‹é™æ¸©ï¼Œæˆ–è€…å€Ÿè°ƒä¸´æ—¶åˆ¶å†·è®¾å¤‡ï¼Ÿ</p>
          </div>
        </div>
      `
    } else {
      return `
        <div class="ai-response-structured">
          <div class="response-header">
            <span class="response-icon">ğŸ”</span>
            <strong>æç«¯æ¡ä»¶åˆ†æ</strong>
          </div>

          <div class="analysis-section">
            <h4>ğŸ“Š æ•°æ®å¯¹æ¯”</h4>
            <ul class="analysis-list">
              <li><strong>äººæ•°å¢é•¿ï¼š</strong>40äºº â†’ 60äººï¼ˆ+50%ï¼‰</li>
              <li><strong>çƒ­é‡äº§ç”Ÿï¼š</strong>4000W â†’ 6000Wï¼ˆ+50%ï¼‰</li>
              <li><strong>å¯†åº¦å¢åŠ ï¼š</strong>0.67äºº/ã¡ â†’ 1.0äºº/ã¡ï¼ˆ+49%ï¼‰</li>
              <li><strong>å¤–ç•Œæ¸©åº¦ï¼š</strong>35â„ƒ â†’ 37â„ƒï¼ˆ+2â„ƒï¼‰</li>
            </ul>
          </div>

          <div class="insight-box">
            <span class="insight-icon">âš ï¸</span>
            <strong>å…³é”®æ€è€ƒï¼š</strong>åŸæ¥çš„èŠ‚èƒ½æ–¹æ¡ˆåœ¨è¿™ç§æç«¯æ¡ä»¶ä¸‹è¿˜é€‚ç”¨å—ï¼Ÿéœ€è¦ä»€ä¹ˆæ ·çš„"åº”æ€¥é¢„æ¡ˆ"ï¼Ÿ
          </div>
        </div>
      `
    }
  } else {
    if (answerLower.includes('é¢„å†·') || answerLower.includes('æå‰')) {
      return `
        <div class="ai-response-structured">
          <div class="response-header">
            <span class="response-icon">â°</span>
            <strong>é¢„å†·ç­–ç•¥å¾ˆæœ‰å‰ç»æ€§ï¼</strong>
          </div>

          <div class="analysis-section">
            <p>ç»“åˆä½ ä¹‹å‰æåˆ°çš„æƒ³æ³•ï¼Œé¢„å†·ç¡®å®æ˜¯åº”å¯¹æç«¯æƒ…å†µçš„æœ‰æ•ˆæ–¹æ³•ï¼š</p>

            <h4>ğŸ¯ é¢„å†·æ—¶é—´è§„åˆ’</h4>
            <div class="timeline-analysis">
              <div class="time-slot">
                <strong>è€ƒè¯•å‰3å°æ—¶ï¼š</strong>ç©ºè°ƒå¼€å§‹é¢„å†·è‡³20â„ƒ
              </div>
              <div class="time-slot">
                <strong>è€ƒè¯•å‰1å°æ—¶ï¼š</strong>å­¦ç”Ÿå…¥åœºï¼Œæ¸©åº¦ä¸Šå‡ä½†æœ‰ç¼“å†²
              </div>
              <div class="time-slot">
                <strong>è€ƒè¯•æœŸé—´ï¼š</strong>ç»´æŒ24-26â„ƒèˆ’é€‚æ¸©åº¦
              </div>
            </div>
          </div>

          <div class="follow-up-question">
            <span class="question-icon">ğŸ’­</span>
            <em>è¿™ç§é¢„å†·ç­–ç•¥çš„èƒ½è€—æˆæœ¬ä½ æœ‰è€ƒè™‘è¿‡å—ï¼Ÿå¯èƒ½éœ€è¦å¤šå°‘é¢å¤–ç”µè´¹ï¼Ÿ</em>
          </div>
        </div>
      `
    } else if (answerLower.includes('åˆ†æ‰¹') || answerLower.includes('åˆ†æµ')) {
      return `
        <div class="ai-response-structured">
          <div class="response-header">
            <span class="response-icon">ğŸ‘¥</span>
            <strong>äººå‘˜åˆ†æµç®¡ç†æ€è·¯</strong>
          </div>

          <div class="analysis-section">
            <p>è¿™æ˜¯ä¸€ä¸ªå¾ˆå®ç”¨çš„ç®¡ç†ç­–ç•¥ï¼åŸºäºä½ çš„æ€è·¯ï¼š</p>

            <h4>ğŸ“‹ åˆ†æµæ–¹æ¡ˆå¯¹æ¯”</h4>
            <ul class="analysis-list">
              <li><strong>æ—¶é—´åˆ†æ‰¹ï¼š</strong>30äºº+30äººï¼Œåˆ†ä¸¤ä¸ªæ—¶æ®µ</li>
              <li><strong>ç©ºé—´åˆ†æµï¼š</strong>ä½¿ç”¨2ä¸ªæ•™å®¤ï¼Œé™ä½å¯†åº¦</li>
              <li><strong>æ··åˆæ–¹æ¡ˆï¼š</strong>é‡è¦è€ƒè¯•æ­£å¸¸è¿›è¡Œï¼Œå…¶ä»–æ´»åŠ¨è°ƒæ•´</li>
            </ul>
          </div>

          <div class="challenge-section">
            <h4>ğŸ¤” å®æ–½æŒ‘æˆ˜</h4>
            <p>ä½†æ˜¯åˆ†æµä¹Ÿæœ‰é™åˆ¶ï¼š<strong>è€ƒè¯•å…¬å¹³æ€§ã€ç›‘è€ƒäººå‘˜å®‰æ’ã€é¢˜ç›®ä¿å¯†</strong>ç­‰é—®é¢˜ã€‚ä½ è§‰å¾—åœ¨ä¿è¯å…¬å¹³çš„å‰æä¸‹ï¼Œå“ªç§åˆ†æµæ–¹å¼æœ€å¯è¡Œï¼Ÿ</p>
          </div>
        </div>
      `
    } else {
      return `
        <div class="ai-response-structured">
          <div class="response-header">
            <span class="response-icon">ğŸ¯</span>
            <strong>æ·±å…¥åˆ†æä½ çš„æƒ³æ³•</strong>
          </div>

          <div class="analysis-section">
            <p>åŸºäºå‰é¢çš„è®¨è®ºå’Œä½ ç°åœ¨çš„è§‚ç‚¹ï¼Œæˆ‘çœ‹åˆ°äº†å¾ˆå…¨é¢çš„è€ƒè™‘ï¼š</p>

            <h4>ğŸ” ç»¼åˆè¯„ä¼°</h4>
            <ul class="analysis-list">
              <li><strong>æŠ€æœ¯å¯è¡Œæ€§ï¼š</strong>æ–¹æ¡ˆåœ¨æŠ€æœ¯ä¸Šæ˜¯å¦å¯å®ç°</li>
              <li><strong>æˆæœ¬æ•ˆç›Šï¼š</strong>çŸ­æœŸæˆæœ¬vsé•¿æœŸæ•ˆæœ</li>
              <li><strong>åº”æ€¥æ€§ï¼š</strong>èƒ½å¦å¿«é€Ÿéƒ¨ç½²å’Œæ‰§è¡Œ</li>
            </ul>
          </div>

          <div class="insight-box">
            <span class="insight-icon">ğŸ’¡</span>
            <strong>æ€è€ƒå»¶ä¼¸ï¼š</strong>å¦‚æœè¿™ç§æç«¯æƒ…å†µç»å¸¸å‘ç”Ÿï¼Œä½ ä¼šå»ºè®®å­¦æ ¡åšå“ªäº›é•¿æœŸçš„åŸºç¡€è®¾æ–½æ”¹è¿›ï¼Ÿ
          </div>
        </div>
      `
    }
  }
}

// ä¿å­˜å¯¹è¯åˆ°æ•°æ®åº“
const saveConversationToDB = async (
  userInput: string,
  aiResponse: string,
  context: string,
  eventData?: Step5EventData,
): Promise<void> => {
  try {
    const experimentId = localStorage.getItem('experimentId')
    const studentName = localStorage.getItem('studentName')

    await fetch('/api/conversations/save', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Experiment-ID': experimentId || '',
      },
      body: JSON.stringify({
        sessionId: getSessionId(),
        step: 5,
        stage: 1,
        userInput,
        aiResponse,
        conversationCount: conversationCount.value,
        timestamp: new Date(),
        context,
        experimentId,
        studentName,
        event_data: eventData,
      }),
    })

    console.log('âœ… Step5 - å¯¹è¯å·²ä¿å­˜åˆ°æ•°æ®åº“')
  } catch (error) {
    console.error('âŒ Step5 - ä¿å­˜å¯¹è¯å¤±è´¥:', error)
  }
}

const getSessionId = () => {
  return simpleStorage.getSessionId()
}

// ç”Ÿå‘½å‘¨æœŸ
const showContentSequentially = async () => {
  restoreFromStorage()

  showInfoCard.value = true
  await new Promise((resolve) => setTimeout(resolve, 800))

  showPrompt.value = true
  await new Promise((resolve) => setTimeout(resolve, 1000))

  showAnswerArea.value = true

  if (messages.value.length > 0) {
    nextTick(() => {
      scrollToBottom()
    })
  }
}

// ğŸ”¥ ç»„ä»¶æŒ‚è½½æ—¶ï¼ˆæ·»åŠ åŸ‹ç‚¹ï¼‰
onMounted(async () => {
  console.log('ğŸ¬ Step5 ç»„ä»¶å·²æŒ‚è½½')

  // ğŸ”¥ åŸ‹ç‚¹ - è¿›å…¥ Step5
  await trackStep5Event('step5_enter', getSessionId(), conversationCount.value, {
    hasHistory: messages.value.length > 0,
  })

  showContentSequentially()
})
</script>

<style scoped>
/* å¯¹è¯è½®æ¬¡é™åˆ¶è­¦å‘Š */
.conversation-limit-warning {
  position: sticky;
  top: 0;
  z-index: 10;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 2px solid #f59e0b;
  border-radius: 0 0 12px 12px;
  margin: 0;
  opacity: 0;
  transform: translateY(-100%);
  transition: all 0.5s ease-out;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.conversation-limit-warning.warning-visible {
  opacity: 1;
  transform: translateY(0);
}

.warning-content {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.5rem;
}

.warning-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
  animation: warningPulse 2s infinite;
}

.warning-text {
  color: #92400e;
  font-weight: 600;
  font-size: 0.95rem;
  line-height: 1.4;
}

@keyframes warningPulse {
  0%,
  100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.8;
  }
}

.step-five-container {
  height: 100%;
  display: flex;
  flex-direction: column;
  background: #ffffffdd;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
}

/* å¯¹è¯æ»šåŠ¨åŒºåŸŸ */
.chat-scroll-area {
  flex: 1;
  overflow-y: auto;
  padding: 1.5rem;
  padding-bottom: 0;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  scrollbar-width: thin;
  scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
}

.chat-scroll-area::-webkit-scrollbar {
  width: 6px;
}

.chat-scroll-area::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.05);
  border-radius: 3px;
}

.chat-scroll-area::-webkit-scrollbar-thumb {
  background: rgba(102, 126, 234, 0.3);
  border-radius: 3px;
}

.chat-scroll-area::-webkit-scrollbar-thumb:hover {
  background: rgba(102, 126, 234, 0.5);
}

/* å¯¹è¯æ¶ˆæ¯åŒºåŸŸ */
.chat-messages {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* ä¿¡æ¯å¡ç‰‡æ ·å¼ - åº”æ€¥ä¸»é¢˜ */
.info-card-section {
  flex-shrink: 0;
}

.info-card {
  background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
  border: 2px solid #ef4444;
  border-radius: 20px;
  padding: 1.5rem;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.6s ease-out;
}

.info-card.card-visible {
  opacity: 1;
  transform: translateY(0);
}

.card-header {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.card-icon {
  background: linear-gradient(45deg, #ef4444, #dc2626);
  width: 3rem;
  height: 3rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%,
  100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

.card-title {
  color: #991b1b;
  font-size: 1rem;
  line-height: 1.6;
  font-weight: 500;
}

.card-content h4 {
  color: #991b1b;
  font-size: 0.9rem;
  margin: 0 0 1rem 0;
  font-weight: 600;
}

.chart-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  align-items: flex-start;
}

/* é¢˜æ³¨æ ·å¼ */
.density-comparison h5,
.emergency-status h5 {
  color: #991b1b;
  font-size: 0.85rem;
  margin: 0 0 0.75rem 0;
  font-weight: 600;
  text-align: center;
  padding: 0.5rem;
  background: rgba(239, 68, 68, 0.1);
  border-radius: 6px;
  border-left: 3px solid #ef4444;
}

/* äººæ•°å¯†åº¦å¯¹æ¯”å›¾ */
.density-comparison {
  background: white;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.density-comparison h5 {
  margin: 0 0 1rem 0;
  color: #374151;
  font-size: 0.85rem;
  font-weight: 600;
}

.comparison-bars {
  display: flex;
  justify-content: space-around;
  align-items: end;
  height: 120px;
  margin-bottom: 1rem;
}

.bar-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
}

.bar {
  width: 40px;
  height: 80px;
  background: #f3f4f6;
  border-radius: 4px;
  position: relative;
  display: flex;
  align-items: end;
  justify-content: center;
  overflow: hidden;
}

.bar-fill {
  width: 100%;
  border-radius: 4px;
  transition: height 0.6s ease-out;
}

.bar.normal .bar-fill {
  background: linear-gradient(to top, #22c55e, #16a34a);
}

.bar.emergency .bar-fill {
  background: linear-gradient(to top, #ef4444, #dc2626);
}

.bar-value {
  position: absolute;
  color: white;
  font-size: 0.7rem;
  font-weight: 600;
  bottom: 4px;
}

.bar-label {
  font-size: 0.75rem;
  color: #374151;
  font-weight: 500;
}

.bar-note {
  font-size: 0.65rem;
  color: #6b7280;
}

.bar-note.critical {
  color: #ef4444;
  font-weight: 600;
}

.impact-note {
  background: #fef3c7;
  border: 1px solid #f59e0b;
  border-radius: 8px;
  padding: 0.5rem;
  font-size: 0.75rem;
  color: #92400e;
  font-weight: 500;
  text-align: center;
}

/* åº”æ€¥çŠ¶æ€é¢æ¿ */
.emergency-status {
  background: white;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.emergency-status h5 {
  margin: 0 0 1rem 0;
  color: #374151;
  font-size: 0.85rem;
  font-weight: 600;
}

.status-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.75rem;
}

.status-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  position: relative;
  transition: all 0.3s ease;
}

.status-item.warning {
  background: #fef3c7;
  border-color: #f59e0b;
}

.status-item.critical {
  background: #fee2e2;
  border-color: #ef4444;
  animation: blink 2s infinite;
}

@keyframes blink {
  0%,
  50%,
  100% {
    opacity: 1;
  }
  25%,
  75% {
    opacity: 0.7;
  }
}

.status-icon {
  font-size: 1.2rem;
  flex-shrink: 0;
}

.status-info {
  display: flex;
  flex-direction: column;
  gap: 0.1rem;
  flex: 1;
}

.status-value {
  font-size: 0.9rem;
  font-weight: 700;
  color: #1e293b;
  line-height: 1.2;
}

.status-label {
  font-size: 0.7rem;
  color: #64748b;
  font-weight: 500;
  line-height: 1.2;
}

.status-alert {
  font-size: 0.65rem;
  color: #ef4444;
  font-weight: 600;
  background: #fee2e2;
  padding: 1px 4px;
  border-radius: 3px;
  align-self: flex-start;
  margin-top: 0.1rem;
}

/* å¯¹è¯æ¶ˆæ¯æ ·å¼ */
.message {
  display: flex;
  margin-bottom: 1.5rem;
  animation: slideIn 0.3s ease-out;
}

.message.user {
  flex-direction: row-reverse;
}

.message-avatar {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  flex-shrink: 0;
  color: white;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.message.ai .message-avatar {
  background: linear-gradient(45deg, #4caf50, #2196f3);
  margin-right: 0.75rem;
}

.message.user .message-avatar {
  background: linear-gradient(45deg, #667eea, #764ba2);
  margin-left: 0.75rem;
}

.message-content {
  max-width: 70%;
  background: #f1f5f9;
  padding: 1rem 1.25rem;
  border-radius: 18px;
  position: relative;
  font-size: 0.95rem;
  line-height: 1.5;
  color: #334155;
  border: 1px solid #e2e8f0;
}

.message.user .message-content {
  background: linear-gradient(45deg, #667eea, #764ba2);
  color: white;
  border-color: transparent;
}

.message-text {
  margin-bottom: 0.5rem;
}

.message-time {
  font-size: 0.75rem;
  opacity: 0.7;
  text-align: right;
  margin-top: 0.25rem;
}

.message.user .message-time {
  color: rgba(255, 255, 255, 0.8);
}

/* åŠ è½½åŠ¨ç”»æ ·å¼ */
.loading-message {
  animation: slideIn 0.3s ease-out;
}

.loading-content {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 2px solid #0ea5e9;
  max-width: 80%;
}

.loading-animation {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  align-items: center;
}

.loading-dots {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #0ea5e9;
  animation: bounce 1.4s infinite ease-in-out;
}

.dot:nth-child(1) {
  animation-delay: -0.32s;
}
.dot:nth-child(2) {
  animation-delay: -0.16s;
}
.dot:nth-child(3) {
  animation-delay: 0s;
}

@keyframes bounce {
  0%,
  80%,
  100% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  40% {
    transform: scale(1.2);
    opacity: 1;
  }
}

.loading-text {
  color: #0369a1;
  font-size: 0.9rem;
  text-align: center;
  font-weight: 500;
}

.loading-progress {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.progress-bar {
  width: 100%;
  height: 6px;
  background: #e0f2fe;
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #0ea5e9, #0284c7);
  border-radius: 3px;
  animation: progressAnimation 3s ease-in-out infinite;
}

@keyframes progressAnimation {
  0% {
    width: 0%;
  }
  50% {
    width: 60%;
  }
  100% {
    width: 90%;
  }
}

.progress-steps {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
}

.step {
  color: #94a3b8;
  transition: color 0.3s ease;
}

.step.active {
  color: #0369a1;
  font-weight: 600;
}

/* åº•éƒ¨ç”¨æˆ·è¾“å…¥åŒºåŸŸ */
.input-section {
  border-top: 1px solid #e2e8f0;
  background: white;
  padding: 1.5rem;
  flex-shrink: 0;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.6s ease-out;
}

.input-section.input-visible {
  opacity: 1;
  transform: translateY(0);
}

.input-container {
  max-width: 100%;
}

.user-input {
  width: 100%;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 1rem;
  font-size: 1rem;
  line-height: 1.5;
  color: #334155;
  background: #f8fafc;
  resize: vertical;
  min-height: 80px;
  font-family: inherit;
  transition:
    border-color 0.3s ease,
    background-color 0.3s ease;
}

.user-input:focus {
  outline: none;
  border-color: #3b82f6;
  background: white;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.user-input::placeholder {
  color: #94a3b8;
}

.user-input:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  background: #f1f5f9;
  border-color: #cbd5e1;
}

.input-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 1rem;
  gap: 1rem;
}

.help-button {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: linear-gradient(45deg, #f1f5f9, #e2e8f0);
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  padding: 0.75rem 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
  color: #475569;
  font-weight: 500;
}

.help-button:hover:not(:disabled) {
  background: linear-gradient(45deg, #e2e8f0, #cbd5e1);
  border-color: #94a3b8;
  transform: translateY(-1px);
}

.help-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.help-icon {
  font-size: 1rem;
}

/* ğŸ”¥ æ–°å¢ï¼šå¸®åŠ©æŒ‰é’®å¾½ç«  - ä½¿ç”¨è“è‰²ä¸»é¢˜ */
.help-badge {
  display: inline-block;
  background: linear-gradient(45deg, #0ea5e9, #0284c7);
  color: white;
  font-size: 0.75rem;
  padding: 0.15rem 0.5rem;
  border-radius: 12px;
  margin-left: 0.5rem;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(14, 165, 233, 0.3);
}

.action-buttons {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.submit-button,
.next-button {
  padding: 0.75rem 2rem;
  border-radius: 25px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.submit-button {
  background: linear-gradient(45deg, #ef4444, #dc2626);
  color: white;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  position: relative;
}

.submit-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
}

.submit-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.next-button {
  background: linear-gradient(45deg, #10b981, #059669);
  color: white;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.next-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
}

/* æŒ‰é’®å†…åŠ è½½åŠ¨ç”» */
.button-loading-dots {
  display: inline-flex;
  gap: 3px;
  margin-right: 8px;
}

.button-dot {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: currentColor;
  animation: buttonBounce 1.4s infinite ease-in-out;
}

.button-dot:nth-child(1) {
  animation-delay: -0.32s;
}
.button-dot:nth-child(2) {
  animation-delay: -0.16s;
}
.button-dot:nth-child(3) {
  animation-delay: 0s;
}

@keyframes buttonBounce {
  0%,
  80%,
  100% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  40% {
    transform: scale(1.2);
    opacity: 1;
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ğŸ”¥ æ–°å¢ï¼šå¸®åŠ©å¼¹çª—æ ·å¼ */
.help-dialog-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.3s ease-out;
}

.help-dialog {
  background: white;
  border-radius: 20px;
  padding: 0;
  max-width: 600px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s ease-out;
}

.help-dialog-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem 2rem;
  border-bottom: 2px solid #e2e8f0;
  position: sticky;
  top: 0;
  background: white;
  z-index: 1;
  border-radius: 20px 20px 0 0;
}

.help-dialog-icon {
  width: 3rem;
  height: 3rem;
  border-radius: 50%;
  background: linear-gradient(45deg, #3b82f6, #1d4ed8);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  flex-shrink: 0;
}

.help-dialog-header h3 {
  color: #1e293b;
  font-size: 1.3rem;
  margin: 0;
  font-weight: 600;
  flex: 1;
}

.close-button {
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  border: none;
  background: #f1f5f9;
  color: #64748b;
  font-size: 1.2rem;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.close-button:hover {
  background: #e2e8f0;
  color: #334155;
}

.help-dialog-content {
  padding: 2rem;
}

.help-dialog-description {
  color: #475569;
  font-size: 1rem;
  line-height: 1.6;
  margin: 0 0 1.5rem 0;
  text-align: center;
}

.help-options {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.help-option {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1.25rem;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: left;
  width: 100%;
}

.help-option:hover:not(:disabled) {
  border-color: #3b82f6;
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.help-option.active {
  border-color: #3b82f6;
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
}

.help-option:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.help-option.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.help-option.disabled:hover {
  transform: none;
  border-color: #e2e8f0;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.option-icon {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.option-content {
  flex: 1;
}

.option-title {
  font-size: 1rem;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 0.25rem;
}

.option-description {
  font-size: 0.85rem;
  color: #64748b;
  line-height: 1.4;
}

.option-arrow {
  font-size: 1.5rem;
  color: #94a3b8;
  flex-shrink: 0;
  transition: transform 0.3s ease;
}

.help-option:hover:not(:disabled) .option-arrow {
  transform: translateX(4px);
  color: #3b82f6;
}

/* ğŸ”¥ æ–°å¢ï¼šå·²ä½¿ç”¨æ ‡è®° */
.used-badge {
  display: inline-block;
  background: #e2e8f0;
  color: #64748b;
  font-size: 0.75rem;
  padding: 0.15rem 0.5rem;
  border-radius: 12px;
  margin-left: 0.5rem;
  font-weight: 500;
}

/* ğŸ”¥ æ–°å¢ï¼šå‘¨æœŸä¿¡æ¯ */
.help-cycle-info {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  margin-top: 1.5rem;
  padding: 1rem;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 1px solid #0ea5e9;
  border-radius: 8px;
  font-size: 0.9rem;
  color: #0369a1;
  font-weight: 500;
}

.cycle-icon {
  font-size: 1.1rem;
}

.cycle-tip {
  font-size: 0.85rem;
  color: #64748b;
}

/* è‡ªå®šä¹‰é—®é¢˜è¾“å…¥åŒºåŸŸ */
.custom-question-section {
  margin-top: 1.5rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 2px solid #f59e0b;
  border-radius: 12px;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.custom-question-input {
  width: 100%;
  box-sizing: border-box;
  border: 2px solid #f59e0b;
  border-radius: 8px;
  padding: 1rem;
  font-size: 0.95rem;
  line-height: 1.5;
  color: #334155;
  background: white;
  resize: vertical;
  min-height: 80px;
  font-family: inherit;
  transition: border-color 0.3s ease;
}

.custom-question-input:focus {
  outline: none;
  border-color: #f97316;
  box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
}

.custom-question-input::placeholder {
  color: #94a3b8;
}

.custom-question-actions {
  display: flex;
  gap: 1rem;
  margin-top: 1rem;
  justify-content: flex-end;
}

.cancel-custom-button,
.submit-custom-button {
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.cancel-custom-button {
  background: white;
  color: #64748b;
  border: 2px solid #e2e8f0;
}

.cancel-custom-button:hover {
  background: #f8fafc;
  border-color: #cbd5e1;
}

.submit-custom-button {
  background: linear-gradient(45deg, #f59e0b, #f97316);
  color: white;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.submit-custom-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
}

.submit-custom-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* æç¤ºä¿¡æ¯ */
.help-tip {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 1px solid #f59e0b;
  border-radius: 8px;
  padding: 1rem;
  margin-top: 1rem;
  font-size: 0.9rem;
  color: #92400e;
  animation: slideDown 0.3s ease-out;
}

.tip-icon {
  font-size: 1.1rem;
  flex-shrink: 0;
}

/* ğŸ”¥ æ–°å¢ï¼šé™åˆ¶æç¤ºå¼¹çª— */
.help-limit-dialog {
  background: white;
  border-radius: 20px;
  padding: 2rem;
  max-width: 400px;
  width: 90%;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s ease-out;
}

.limit-dialog-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
}

.help-limit-dialog h3 {
  color: #1e293b;
  font-size: 1.3rem;
  margin: 0 0 1rem 0;
  font-weight: 600;
}

.help-limit-dialog p {
  color: #475569;
  font-size: 1rem;
  line-height: 1.6;
  margin: 0 0 1rem 0;
}

.limit-tip {
  color: #64748b;
  font-size: 0.9rem;
  line-height: 1.6;
  margin-top: 1rem;
}

.limit-confirm-button {
  margin-top: 1.5rem;
  padding: 0.75rem 2rem;
  border-radius: 25px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  background: linear-gradient(45deg, #3b82f6, #1d4ed8);
  color: white;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.limit-confirm-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1024px) {
  .chart-container {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .status-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .step-five-container {
    border-radius: 8px;
  }

  .chat-scroll-area {
    padding: 1rem;
  }

  .info-card {
    padding: 1rem;
    border-radius: 12px;
  }

  .card-header {
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 0.75rem;
  }

  .card-icon {
    width: 2.5rem;
    height: 2.5rem;
    font-size: 1.1rem;
  }

  .chart-container {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .status-grid {
    grid-template-columns: 1fr;
    gap: 0.5rem;
  }

  .status-item {
    padding: 0.75rem;
  }

  .status-icon {
    font-size: 1rem;
  }

  .status-value {
    font-size: 0.85rem;
  }

  .status-label {
    font-size: 0.7rem;
  }

  .message-content {
    max-width: 85%;
  }

  .loading-content {
    max-width: 90%;
  }

  .input-section {
    padding: 1rem;
  }

  .input-toolbar {
    flex-direction: column;
    align-items: stretch;
    gap: 1rem;
  }

  .action-buttons {
    justify-content: center;
  }

  .loading-text {
    font-size: 0.8rem;
  }

  .progress-steps {
    font-size: 0.7rem;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .comparison-bars {
    height: 100px;
  }

  .bar {
    width: 30px;
    height: 60px;
  }

  .submit-button,
  .next-button {
    padding: 0.6rem 1.5rem;
    font-size: 0.9rem;
  }

  .confirm-dialog {
    width: 95%;
    padding: 1.5rem;
    max-height: 85vh;
  }

  .dialog-header h3 {
    font-size: 1.1rem;
  }

  .dialog-icon {
    width: 2.5rem;
    height: 2.5rem;
    font-size: 1.3rem;
  }

  .dialog-content p {
    font-size: 0.9rem;
  }

  .completion-summary {
    padding: 1rem;
  }

  .summary-item {
    font-size: 0.85rem;
  }

  .dialog-warning {
    font-size: 0.8rem;
    padding: 0.75rem;
  }

  .dialog-actions {
    flex-direction: column;
    gap: 0.75rem;
  }

  .cancel-button,
  .confirm-button {
    width: 100%;
    padding: 0.75rem;
    font-size: 0.9rem;
  }

  .warning-content {
    padding: 0.75rem 1rem;
  }

  .warning-text {
    font-size: 0.85rem;
  }

  .help-dialog {
    width: 95%;
    max-height: 90vh;
  }

  .help-dialog-header {
    padding: 1.25rem 1.5rem;
  }

  .help-dialog-header h3 {
    font-size: 1.1rem;
  }

  .help-dialog-icon {
    width: 2.5rem;
    height: 2.5rem;
    font-size: 1.3rem;
  }

  .help-dialog-content {
    padding: 1.5rem;
  }

  .help-option {
    padding: 1rem;
  }

  .option-icon {
    width: 2rem;
    height: 2rem;
    font-size: 1.1rem;
  }

  .option-title {
    font-size: 0.9rem;
  }

  .option-description {
    font-size: 0.8rem;
  }

  .custom-question-section {
    padding: 1rem;
  }

  .custom-question-actions {
    flex-direction: column;
  }

  .cancel-custom-button,
  .submit-custom-button {
    width: 100%;
  }
}

@media (max-width: 480px) {
  .chat-scroll-area {
    padding: 0.75rem;
  }

  .input-section {
    padding: 0.75rem;
  }

  .status-grid {
    grid-template-columns: 1fr;
    gap: 0.5rem;
  }

  .status-item {
    padding: 0.75rem;
  }

  .card-title {
    font-size: 0.9rem;
  }

  .status-value {
    font-size: 0.8rem;
  }

  .status-label {
    font-size: 0.65rem;
  }

  .confirm-dialog {
    padding: 1rem;
  }

  .dialog-header {
    flex-direction: column;
    text-align: center;
    gap: 0.75rem;
  }

  .summary-item {
    font-size: 0.8rem;
  }

  .warning-content {
    flex-direction: column;
    text-align: center;
    gap: 0.75rem;
  }

  .warning-icon {
    font-size: 1.3rem;
  }

  .warning-text {
    font-size: 0.8rem;
  }
}

/* ==================== ç¡®è®¤å¼¹çª—ç»Ÿä¸€æ ·å¼ ==================== */
.confirm-dialog-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.3s ease-out;
}

.confirm-dialog {
  background: white;
  border-radius: 20px;
  padding: 2rem;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s ease-out;
}

.dialog-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid #e2e8f0;
}

.dialog-icon {
  width: 3rem;
  height: 3rem;
  border-radius: 50%;
  background: linear-gradient(45deg, #0ea5e9, #0284c7);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  flex-shrink: 0;
}

.dialog-header h3 {
  color: #1e293b;
  font-size: 1.3rem;
  margin: 0;
  font-weight: 600;
}

.dialog-content {
  margin-bottom: 2rem;
}

.dialog-content p {
  color: #475569;
  font-size: 1rem;
  line-height: 1.6;
  margin-bottom: 1.5rem;
}

/* å¿«ç…§é¢„è§ˆåŒºåŸŸ */
.answer-preview {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 2px solid #0ea5e9;
  border-radius: 12px;
  padding: 1rem;
  margin: 1.5rem 0;
  animation: slideIn 0.3s ease-out;
}

.preview-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid rgba(14, 165, 233, 0.2);
}

.preview-icon {
  font-size: 1.2rem;
}

.preview-title {
  font-weight: 600;
  color: #0369a1;
  font-size: 0.95rem;
}

/* ğŸ”¥ æ–°å¢ï¼šä»»åŠ¡æ ‡é¢˜æ ·å¼ */
.task-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  background: white;
  border: 1px solid #e0f2fe;
  border-radius: 8px;
  margin-bottom: 0.75rem;
}

.task-icon {
  font-size: 1.1rem;
  flex-shrink: 0;
}

.task-text {
  font-size: 0.9rem;
  color: #334155;
  font-weight: 500;
  line-height: 1.4;
}

.preview-body {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.preview-textarea {
  width: 100%;
  border: 2px solid #0ea5e9;
  border-radius: 8px;
  padding: 0.75rem;
  font-size: 0.9rem;
  line-height: 1.6;
  color: #334155;
  background: white;
  resize: vertical;
  min-height: 200px;
  font-family: inherit;
  transition: all 0.3s ease;
}

.preview-textarea:focus {
  outline: none;
  border-color: #0284c7;
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

.preview-hint {
  color: #64748b;
  font-size: 0.85rem;
  margin: 0;
  font-style: italic;
}

.char-count {
  text-align: right;
  font-size: 0.8rem;
  color: #94a3b8;
}

/* å®Œæˆæ‘˜è¦ */
.completion-summary {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1rem;
}

.summary-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
  font-size: 0.95rem;
  color: #334155;
}

.summary-item:last-child {
  margin-bottom: 0;
}

.summary-icon {
  font-size: 1.1rem;
  flex-shrink: 0;
}

/* è­¦å‘Šæç¤º */
.dialog-warning {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 1px solid #f59e0b;
  border-radius: 8px;
  padding: 1rem;
  font-size: 0.9rem;
  color: #92400e;
}

.warning-icon {
  font-size: 1.1rem;
  flex-shrink: 0;
}

/* æŒ‰é’®åŒºåŸŸ */
.dialog-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
}

.cancel-button,
.confirm-button {
  padding: 0.75rem 2rem;
  border-radius: 25px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.cancel-button {
  background: #f1f5f9;
  color: #475569;
  border: 2px solid #e2e8f0;
}

.cancel-button:hover {
  background: #e2e8f0;
  transform: translateY(-1px);
}

.confirm-button {
  background: linear-gradient(45deg, #10b981, #059669);
  color: white;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.confirm-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
}

.confirm-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* å“åº”å¼ */
@media (max-width: 768px) {
  .confirm-dialog {
    width: 95%;
    padding: 1.5rem;
    max-height: 85vh;
  }

  .dialog-header h3 {
    font-size: 1.1rem;
  }

  .dialog-icon {
    width: 2.5rem;
    height: 2.5rem;
    font-size: 1.3rem;
  }

  .dialog-content p {
    font-size: 0.9rem;
  }

  .completion-summary {
    padding: 1rem;
  }

  .summary-item {
    font-size: 0.85rem;
  }

  .dialog-warning {
    font-size: 0.8rem;
    padding: 0.75rem;
  }

  .dialog-actions {
    flex-direction: column;
    gap: 0.75rem;
  }

  .cancel-button,
  .confirm-button {
    width: 100%;
    padding: 0.75rem;
    font-size: 0.9rem;
  }

  .task-title {
    padding: 0.5rem 0.75rem;
  }

  .task-text {
    font-size: 0.85rem;
  }
}
</style>
