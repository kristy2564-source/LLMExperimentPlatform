<template>
  <div class="step-three-container">
    <!-- å¯¹è¯è½®æ¬¡é™åˆ¶æç¤º -->
    <div
      v-if="conversationCount >= 4"
      class="conversation-limit-warning"
      :class="{ 'warning-visible': showConversationWarning }"
    >
      <div class="warning-content">
        <div class="warning-icon">âš ï¸</div>
        <div class="warning-text">
          <span v-if="conversationCount === 4">æ‚¨å·²ç»è¿›è¡Œäº†4è½®å¯¹è¯ï¼Œè¿˜æœ‰1æ¬¡æäº¤æœºä¼š</span>
          <span v-else>æ‚¨å·²è¾¾åˆ°æœ€å¤§å¯¹è¯æ¬¡æ•°ï¼ˆ5è½®ï¼‰ï¼Œè¯·ç‚¹å‡»"ç»§ç»­ä¸‹ä¸€æ­¥"æŒ‰é’®è¿›å…¥ä¸‹ä¸€é˜¶æ®µ</span>
        </div>
      </div>
    </div>

    <!-- å¯¹è¯æ»šåŠ¨åŒºåŸŸ -->
    <div class="chat-scroll-area" ref="chatScrollArea">
      <!-- ä¿¡æ¯å¡ç‰‡åŒºåŸŸ -->
      <div class="info-card-section">
        <div class="info-card" :class="{ 'card-visible': showInfoCard }">
          <div class="card-header">
            <div class="card-icon">âš¡</div>
            <div class="card-title">
              åŸºäºStep2çš„é—®é¢˜åˆ†æï¼Œç°åœ¨éœ€è¦åˆ¶å®šå…·ä½“çš„èŠ‚èƒ½ç­–ç•¥ã€‚
              æ•™å®¤é¢ä¸´çš„ä¸»è¦æŒ‘æˆ˜åŒ…æ‹¬ï¼š40äººäº§ç”Ÿçš„çƒ­é‡ã€35â„ƒçš„é«˜æ¸©ã€
              ç©ºè°ƒ3.2kWçš„é«˜è€—ç”µã€ä»¥åŠæœ‰é™çš„è‡ªç„¶é€šé£æ¡ä»¶ã€‚ ä½ èƒ½æå‡ºå“ªäº›åˆ‡å®å¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Ÿ
            </div>
          </div>

          <div class="card-content">
            <div class="chart-section">
              <h4>ğŸ’¡ ç­–ç•¥åˆ¶å®šå‚è€ƒæ•°æ®ï¼š</h4>
              <div class="chart-container">
                <!-- èŠ‚èƒ½ç­–ç•¥å¯¹æ¯”è¡¨ -->
                <div class="strategy-comparison">
                  <h5>â­ å¸¸è§èŠ‚èƒ½ç­–ç•¥æ•ˆæœå¯¹æ¯”</h5>
                  <div class="strategy-table">
                    <div class="strategy-row header">
                      <div class="strategy-cell">ç­–ç•¥ç±»å‹</div>
                      <div class="strategy-cell">èŠ‚èƒ½æ•ˆæœ</div>
                      <div class="strategy-cell">å®æ–½æˆæœ¬</div>
                      <div class="strategy-cell">é€‚ç”¨æ¡ä»¶</div>
                    </div>
                    <div class="strategy-row">
                      <div class="strategy-cell"><span class="strategy-icon">ğŸŒ¬ï¸</span>è‡ªç„¶é€šé£</div>
                      <div class="strategy-cell"><div class="effect-bar high">é«˜</div></div>
                      <div class="strategy-cell"><div class="cost-indicator low">ä½</div></div>
                      <div class="strategy-cell">æœ‰é£å¤©æ°”</div>
                    </div>
                    <div class="strategy-row">
                      <div class="strategy-cell"><span class="strategy-icon">â„ï¸</span>æ™ºèƒ½ç©ºè°ƒ</div>
                      <div class="strategy-cell"><div class="effect-bar medium">ä¸­</div></div>
                      <div class="strategy-cell"><div class="cost-indicator medium">ä¸­</div></div>
                      <div class="strategy-cell">å…¨å¤©å€™</div>
                    </div>
                    <div class="strategy-row">
                      <div class="strategy-cell"><span class="strategy-icon">ğŸ•</span>é”™å³°ä½¿ç”¨</div>
                      <div class="strategy-cell"><div class="effect-bar medium">ä¸­</div></div>
                      <div class="strategy-cell"><div class="cost-indicator low">ä½</div></div>
                      <div class="strategy-cell">å¯è°ƒåº¦æ—¶</div>
                    </div>
                    <div class="strategy-row">
                      <div class="strategy-cell"><span class="strategy-icon">ğŸŒ¡ï¸</span>èŠ‚èƒ½åˆ†åŒº</div>
                      <div class="strategy-cell"><div class="effect-bar high">é«˜</div></div>
                      <div class="strategy-cell"><div class="cost-indicator high">é«˜</div></div>
                      <div class="strategy-cell">æ”¹é€ æœŸ</div>
                    </div>
                  </div>
                </div>

                <!-- å†³ç­–è¦ç´ åˆ†æ -->
                <div class="decision-factors">
                  <h5>ğŸ¯ ç­–ç•¥é€‰æ‹©è¦ç´ </h5>
                  <div class="factors-grid">
                    <div class="factor-item">
                      <span class="factor-icon">ğŸŒ¤ï¸</span>
                      <div class="factor-content">
                        <div class="factor-title">å¤©æ°”é€‚åº”æ€§</div>
                        <div class="factor-desc">ä¸åŒå¤©æ°”æ¡ä»¶ä¸‹çš„æœ‰æ•ˆæ€§</div>
                      </div>
                    </div>
                    <div class="factor-item">
                      <span class="factor-icon">ğŸ’°</span>
                      <div class="factor-content">
                        <div class="factor-title">æˆæœ¬æ•ˆç›Š</div>
                        <div class="factor-desc">åˆæœŸæŠ•å…¥vsé•¿æœŸèŠ‚çœ</div>
                      </div>
                    </div>
                    <div class="factor-item">
                      <span class="factor-icon">âš¡</span>
                      <div class="factor-content">
                        <div class="factor-title">èƒ½è€—æ•ˆç‡</div>
                        <div class="factor-desc">å•ä½æ—¶é—´èŠ‚èƒ½é‡</div>
                      </div>
                    </div>
                    <div class="factor-item">
                      <span class="factor-icon">ğŸ”§</span>
                      <div class="factor-content">
                        <div class="factor-title">å®æ–½éš¾åº¦</div>
                        <div class="factor-desc">æŠ€æœ¯è¦æ±‚å’Œæ“ä½œå¤æ‚åº¦</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å¯¹è¯æ¶ˆæ¯åŒºåŸŸ -->
      <div class="chat-messages">
        <!-- åˆå§‹ AI å¼•å¯¼æ¶ˆæ¯ -->
        <div class="message ai" v-if="showPrompt">
          <div class="message-avatar">ğŸ¤–</div>
          <div class="message-content">
            <div class="message-text">
              <strong>è®ºè¯ä¸ç­–ç•¥åˆ¶å®šé˜¶æ®µï¼š</strong>
              æ ¹æ®ä½ è·å¾—çš„æ•°æ®ï¼Œèƒ½å¦æå‡ºä¸¤ä¸ªå¯èƒ½çš„èŠ‚èƒ½ç­–ç•¥ï¼Ÿå®ƒä»¬åˆ†åˆ«çš„ä¼˜åŠ£æ˜¯ä»€ä¹ˆï¼Ÿ <br /><br />
              è¯·è€ƒè™‘ï¼šæ•ˆæœã€æˆæœ¬ã€é€‚ç”¨æ€§ã€å¯æ“ä½œæ€§ç­‰å¤šä¸ªç»´åº¦æ¥åˆ†æä½ çš„æ–¹æ¡ˆã€‚
            </div>
          </div>
        </div>

        <!-- åŠ¨æ€å¯¹è¯æ¶ˆæ¯ - è¿‡æ»¤æ‰systemç±»å‹ -->
        <div
          v-for="message in messages.filter((m) => m.type !== 'system')"
          :key="message.id"
          :class="['message', message.type]"
        >
          <div class="message-avatar">
            {{ message.type === 'ai' ? 'ğŸ¤–' : 'ğŸ‘¤' }}
          </div>
          <div class="message-content">
            <div class="message-text" v-html="message.content"></div>
            <div class="message-time">
              {{ formatTime(message.timestamp) }}
            </div>
          </div>
        </div>

        <!-- AIæ€è€ƒåŠ è½½åŠ¨ç”» -->
        <div v-if="isGenerating" class="message ai loading-message">
          <div class="message-avatar">ğŸ¤–</div>
          <div class="message-content loading-content">
            <div class="loading-animation">
              <div class="loading-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
              </div>
              <div class="loading-text">AIæ­£åœ¨åˆ†æç­–ç•¥æ–¹æ¡ˆï¼Œé¢„è®¡éœ€è¦15-30ç§’...</div>
              <div class="loading-progress">
                <div class="progress-bar">
                  <div class="progress-fill"></div>
                </div>
                <div class="progress-steps">
                  <span class="step active">ğŸ“ ç†è§£ç­–ç•¥</span>
                  <span class="step" :class="{ active: loadingStep >= 2 }">âš–ï¸ å¯¹æ¯”åˆ†æ</span>
                  <span class="step" :class="{ active: loadingStep >= 3 }">ğŸ’¡ ä¼˜åŒ–å»ºè®®</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨ç”¨æˆ·è¾“å…¥åŒºåŸŸ -->
    <div class="input-section" :class="{ 'input-visible': showAnswerArea }">
      <div class="input-container">
        <textarea
          v-model="userAnswer"
          :placeholder="inputPlaceholder"
          class="user-input"
          :disabled="isGenerating || isConversationLimitReached"
          @input="handleInput"
          rows="3"
        ></textarea>
        <div class="input-toolbar">
          <button
            class="help-button"
            @click="requestHelp"
            :disabled="isGenerating || isConversationLimitReached || !canUseHelp"
            :title="getHelpButtonTitle"
          >
            <span class="help-icon">ğŸ’¬</span>
            æˆ‘æƒ³æé—®
            <span v-if="canUseHelp" class="help-badge">
              {{ helpSystem.maxCycles - helpSystem.totalCycles }}
            </span>
          </button>
          <div class="action-buttons">
            <button
              v-if="!isConversationLimitReached"
              class="submit-button"
              @click="submitAnswer"
              :disabled="!canSubmit || isGenerating"
            >
              <span v-if="isGenerating">
                <span class="button-loading-dots">
                  <span class="button-dot"></span>
                  <span class="button-dot"></span>
                  <span class="button-dot"></span>
                </span>
                åˆ†æä¸­...
              </span>
              <span v-else>æäº¤</span>
            </button>
            <button
              class="next-button"
              @click="handleNextStep"
              v-if="answerSubmitted || isConversationLimitReached"
            >
              ç»§ç»­ä¸‹ä¸€æ­¥ â†’
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ğŸ”¥ å¸®åŠ©å¼¹çª— -->
    <div v-if="showHelpDialog" class="help-dialog-overlay" @click="closeHelpDialog">
      <div class="help-dialog" @click.stop>
        <div class="help-dialog-header">
          <div class="help-dialog-icon">ğŸ’¬</div>
          <h3>é€‰æ‹©å¸®åŠ©æ–¹å¼</h3>
          <button class="close-button" @click="closeHelpDialog">âœ•</button>
        </div>

        <div class="help-dialog-content">
          <p class="help-dialog-description">è¯·é€‰æ‹©ä½ éœ€è¦çš„å¸®åŠ©ç±»å‹ï¼š</p>

          <!-- å¸®åŠ©é€‰é¡¹ -->
          <div class="help-options">
            <!-- é€‰é¡¹1ï¼šå®Œå–„å†…å®¹ -->
            <button
              class="help-option"
              :class="{
                active: helpMode === 'refine',
                disabled: !availableHelpModes.refine,
              }"
              @click="selectHelpMode('refine')"
              :disabled="!userAnswer.trim() || !availableHelpModes.refine"
            >
              <div class="option-icon">ğŸ—£</div>
              <div class="option-content">
                <div class="option-title">
                  å¸®æˆ‘å®Œå–„å†…å®¹
                  <span v-if="!availableHelpModes.refine" class="used-badge">å·²ä½¿ç”¨</span>
                </div>
                <div class="option-description">
                  "æˆ‘å¥½åƒå†™å¾—ä¸å¤ªæ¸…æ¥šï¼Œå¸®æˆ‘å®Œå–„ä¸€ä¸‹å§ã€‚"ï¼ˆè¯·å…ˆåœ¨è¾“å…¥æ¡†ä¸­å†™ä¸‹ç­”æ¡ˆï¼Œå†ç‚¹å‡»è¯¥æŒ‰é’®ï¼‰
                </div>
              </div>
              <div class="option-arrow">â†’</div>
            </button>

            <!-- é€‰é¡¹2ï¼šç»™ç¤ºä¾‹ -->
            <button
              class="help-option"
              :class="{
                active: helpMode === 'example',
                disabled: !availableHelpModes.example,
              }"
              @click="selectHelpMode('example')"
              :disabled="!availableHelpModes.example"
            >
              <div class="option-icon">ğŸ’¡</div>
              <div class="option-content">
                <div class="option-title">
                  ç»™æˆ‘çœ‹çœ‹ä¾‹å­
                  <span v-if="!availableHelpModes.example" class="used-badge">å·²ä½¿ç”¨</span>
                </div>
                <div class="option-description">"æˆ‘æœ‰ç‚¹ä¸ç¡®å®šæ€ä¹ˆåšï¼Œèƒ½ç»™ä¸ªå‚è€ƒä¾‹å­å—ï¼Ÿ"</div>
              </div>
              <div class="option-arrow">â†’</div>
            </button>

            <!-- é€‰é¡¹3ï¼šè‡ªå®šä¹‰æé—® -->
            <button
              class="help-option"
              :class="{
                active: helpMode === 'custom',
                disabled: !availableHelpModes.custom,
              }"
              @click="selectHelpMode('custom')"
              :disabled="!availableHelpModes.custom"
            >
              <div class="option-icon">âœï¸</div>
              <div class="option-content">
                <div class="option-title">
                  æˆ‘æƒ³è‡ªå·±æé—®
                  <span v-if="!availableHelpModes.custom" class="used-badge">å·²ä½¿ç”¨</span>
                </div>
                <div class="option-description">"æˆ‘æœ‰å…·ä½“çš„é—®é¢˜æƒ³é—®ã€‚"</div>
              </div>
              <div class="option-arrow">â†’</div>
            </button>
          </div>

          <!-- ğŸ”¥ å‘¨æœŸæç¤º -->
          <div class="help-cycle-info">
            <span class="cycle-icon">ğŸ”„</span>
            <span>å‰©ä½™å¸®åŠ©æ¬¡æ•°ï¼š{{ helpSystem.maxCycles - helpSystem.totalCycles }} æ¬¡</span>
            <span v-if="helpSystem.isInCycle" class="cycle-tip">
              ï¼ˆå½“å‰å‘¨æœŸå·²ä½¿ç”¨
              {{ Object.values(helpSystem.currentCycleUsed).filter(Boolean).length }}/3ï¼‰
            </span>
          </div>

          <!-- è‡ªå®šä¹‰é—®é¢˜è¾“å…¥æ¡† -->
          <div v-if="helpMode === 'custom'" class="custom-question-section">
            <textarea
              v-model="customQuestion"
              placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜..."
              class="custom-question-input"
              rows="3"
              autofocus
            ></textarea>
            <div class="custom-question-actions">
              <button class="cancel-custom-button" @click="helpMode = null">å–æ¶ˆ</button>
              <button
                class="submit-custom-button"
                @click="submitCustomQuestion"
                :disabled="!customQuestion.trim()"
              >
                æäº¤é—®é¢˜
              </button>
            </div>
          </div>

          <!-- å®Œå–„å†…å®¹æç¤º -->
          <div v-if="helpMode === 'refine' && !userAnswer.trim()" class="help-tip">
            <span class="tip-icon">ğŸ’¡</span>
            <span>è¯·å…ˆåœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å†™ä¸€äº›å†…å®¹ï¼Œç„¶åæˆ‘å¯ä»¥å¸®ä½ å®Œå–„ã€‚</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ğŸ”¥ å¸®åŠ©æ¬¡æ•°ç”¨å°½æç¤º -->
    <div v-if="showHelpLimitDialog" class="help-dialog-overlay" @click="closeHelpLimitDialog">
      <div class="help-limit-dialog" @click.stop>
        <div class="limit-dialog-icon">âš ï¸</div>
        <h3>å¸®åŠ©æ¬¡æ•°å·²ç”¨å®Œ</h3>
        <p>æ‚¨å·²ä½¿ç”¨å®Œæ‰€æœ‰çš„å¸®åŠ©æ¬¡æ•°ï¼ˆ{{ helpSystem.maxCycles }} æ¬¡ï¼‰ã€‚</p>
        <p class="limit-tip">è¯·ç»§ç»­ç‹¬ç«‹å®Œæˆå‰©ä½™çš„ä»»åŠ¡ï¼Œæˆ–ç‚¹å‡»"æäº¤å›ç­”"æŒ‰é’®æäº¤æ‚¨çš„ç­”æ¡ˆã€‚</p>
        <button class="limit-confirm-button" @click="closeHelpLimitDialog">çŸ¥é“äº†</button>
      </div>
    </div>

    <!-- ğŸ”¥ å‘¨æœŸå†…å¸®åŠ©å·²ç”¨å°½æç¤º -->
    <div v-if="showCycleLimitDialog" class="help-dialog-overlay" @click="closeCycleLimitDialog">
      <div class="help-limit-dialog" @click.stop>
        <div class="limit-dialog-icon">ğŸ”„</div>
        <h3>å½“å‰å‘¨æœŸçš„å¸®åŠ©å·²å…¨éƒ¨ä½¿ç”¨</h3>
        <p>æ‚¨å·²ä½¿ç”¨å®Œå½“å‰å‘¨æœŸçš„3ç§å¸®åŠ©æ–¹å¼ã€‚</p>
        <p class="limit-tip">
          è¯·å…ˆæäº¤æ‚¨çš„ç­”æ¡ˆï¼Œæäº¤åå°†å¼€å¯æ–°çš„å¸®åŠ©å‘¨æœŸã€‚
          <br />
          å‰©ä½™å¸®åŠ©å‘¨æœŸï¼š<strong>{{ helpSystem.maxCycles - helpSystem.totalCycles }}</strong> æ¬¡
        </p>
        <button class="limit-confirm-button" @click="closeCycleLimitDialog">çŸ¥é“äº†</button>
      </div>
    </div>

    <!-- ğŸ”¥ ä¿®æ”¹ï¼šç¡®è®¤å¼¹çª— - å¯ç¼–è¾‘ç‰ˆæœ¬ -->
    <div v-if="showConfirmDialog" class="confirm-dialog-overlay" @click="closeConfirmDialog">
      <div class="confirm-dialog" @click.stop>
        <div class="dialog-header">
          <div class="dialog-icon">ğŸ¯</div>
          <h3>ç¡®è®¤è¿›å…¥ä¸‹ä¸€æ­¥</h3>
        </div>
        <div class="dialog-content">
          <p>æ‚¨å³å°†å®Œæˆç­–ç•¥åˆ¶å®šé˜¶æ®µï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªå­¦ä¹ ç¯èŠ‚ã€‚è¯·ç¡®è®¤æˆ–ä¿®æ”¹æ‚¨çš„æœ€ç»ˆç­–ç•¥æ–¹æ¡ˆã€‚</p>

          <!-- ğŸ”¥ æ–°å¢ï¼šå¯ç¼–è¾‘çš„å¿«ç…§åŒºåŸŸ -->
          <div v-if="editableFinalAnswer" class="answer-preview">
            <div class="preview-header">
              <span class="preview-icon">ğŸ“</span>
              <span class="preview-title">æœ¬æ­¥éª¤çš„æœ€ç»ˆå†…å®¹ï¼ˆå¯ç¼–è¾‘ï¼‰</span>
            </div>
            <div class="preview-body">
              <textarea
                v-model="editableFinalAnswer"
                class="preview-textarea"
                rows="10"
                placeholder="è¯·è¾“å…¥æˆ–ä¿®æ”¹ä½ çš„æœ€ç»ˆç­–ç•¥æ–¹æ¡ˆ..."
              ></textarea>
              <p class="preview-hint">ğŸ’¡ è¿™æ˜¯æ‚¨æœ€åä¸€æ¬¡ä¿®æ”¹æœºä¼šï¼Œè¯·ä»”ç»†æ£€æŸ¥åç‚¹å‡»"ç¡®å®šç»§ç»­"ã€‚</p>
              <div class="char-count">å­—æ•°ï¼š{{ editableFinalAnswer.length }} å­—ç¬¦</div>
            </div>
          </div>

          <div class="completion-summary">
            <div class="summary-item">
              <span class="summary-icon">ğŸ’¬</span>
              <span>è¿›è¡Œäº† {{ conversationCount }} è½®ç­–ç•¥è®¨è®º</span>
            </div>
            <div class="summary-item" v-if="answerSubmitted">
              <span class="summary-icon">âœ…</span>
              <span>å·²æäº¤èŠ‚èƒ½ç­–ç•¥æ–¹æ¡ˆ</span>
            </div>
            <div class="summary-item" v-if="isConversationLimitReached">
              <span class="summary-icon">â°</span>
              <span>å·²è¾¾åˆ°æœ€å¤§å¯¹è¯è½®æ¬¡é™åˆ¶</span>
            </div>
          </div>
          <div class="dialog-warning">
            <span class="warning-icon">âš ï¸</span>
            <span>è¿›å…¥ä¸‹ä¸€æ­¥åï¼Œæ‚¨å°†æ— æ³•è¿”å›ä¿®æ”¹å½“å‰çš„ç­–ç•¥æ–¹æ¡ˆã€‚</span>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="cancel-button" @click="closeConfirmDialog">è¿”å›å¯¹è¯</button>
          <button
            class="confirm-button"
            @click="confirmNextStep"
            :disabled="!editableFinalAnswer.trim()"
          >
            ç¡®å®šç»§ç»­
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, nextTick, reactive, watch } from 'vue'
import { useRouter } from 'vue-router'
import { simpleStorage } from '../../api/utils/simpleStorage'
import { trackStep3Event } from '../../src/utils/tracking'

// ğŸ”¥ æ–°å¢ï¼šæœ€ç»ˆç­”æ¡ˆå¿«ç…§ç›¸å…³
const finalAnswerSnapshot = ref('') // æœ¬æ­¥æœ€ç»ˆç­”æ¡ˆå¿«ç…§
const finalAnswerConfirmed = ref(false) // æ˜¯å¦å·²ç¡®è®¤æœ€ç»ˆç­”æ¡ˆ
const editableFinalAnswer = ref('') // å¯ç¼–è¾‘çš„æœ€ç»ˆç­”æ¡ˆï¼ˆç”¨äºå¼¹çª—ä¸­ç¼–è¾‘ï¼‰

// ğŸ”¥ æ–°å¢ï¼šå¸®åŠ©ç³»ç»ŸçŠ¶æ€ç®¡ç†
const helpSystem = reactive({
  totalCycles: 0, // å·²ä½¿ç”¨çš„å‘¨æœŸæ•°
  maxCycles: 4, // æœ€å¤§å‘¨æœŸæ•°
  currentCycleUsed: {
    // å½“å‰å‘¨æœŸå†…å·²ä½¿ç”¨çš„æ¨¡å¼
    refine: false,
    example: false,
    custom: false,
  },
  isInCycle: false, // æ˜¯å¦åœ¨å¸®åŠ©å‘¨æœŸä¸­
})

// è®¡ç®—å±æ€§ï¼šå¸®åŠ©åŠŸèƒ½æ˜¯å¦å¯ç”¨
const canUseHelp = computed(() => {
  return helpSystem.totalCycles < helpSystem.maxCycles
})

// è®¡ç®—å±æ€§ï¼šå½“å‰å‘¨æœŸå‰©ä½™å¯ç”¨æ¨¡å¼
const availableHelpModes = computed(() => {
  return {
    refine: !helpSystem.currentCycleUsed.refine,
    example: !helpSystem.currentCycleUsed.example,
    custom: !helpSystem.currentCycleUsed.custom,
  }
})

// è®¡ç®—å±æ€§ï¼šå½“å‰å‘¨æœŸæ˜¯å¦è¿˜æœ‰å¯ç”¨æ¨¡å¼
const hasAvailableModesInCycle = computed(() => {
  return Object.values(availableHelpModes.value).some((available) => available)
})

// å®šä¹‰ç»„ä»¶é€šä¿¡
const emit = defineEmits(['update-progress', 'show-next-steps'])

const router = useRouter()

// å¸®åŠ©å¼¹çª—ç›¸å…³çŠ¶æ€
const showHelpDialog = ref(false)
const helpMode = ref<'refine' | 'example' | 'custom' | null>(null)
const customQuestion = ref('')

// ğŸ”¥ æ–°å¢ï¼šé™åˆ¶æç¤ºå¼¹çª—çŠ¶æ€
const showHelpLimitDialog = ref(false)
const showCycleLimitDialog = ref(false)

// ğŸ”¥ æ–°å¢ï¼šå¸®åŠ©æŒ‰é’® title è®¡ç®—å±æ€§
const getHelpButtonTitle = computed(() => {
  if (!canUseHelp.value) {
    return 'å·²è¾¾åˆ°å¸®åŠ©æ¬¡æ•°ä¸Šé™'
  }
  if (helpSystem.isInCycle && !hasAvailableModesInCycle.value) {
    return 'å½“å‰å‘¨æœŸçš„å¸®åŠ©å·²å…¨éƒ¨ä½¿ç”¨ï¼Œè¯·æäº¤ç­”æ¡ˆåå†ä½¿ç”¨'
  }
  return 'ç‚¹å‡»è·å–æ™ºèƒ½å¸®åŠ©'
})

// ğŸ”¥ æ–°å¢ï¼šå…³é—­é™åˆ¶æç¤ºå¼¹çª—çš„å‡½æ•°
const closeHelpLimitDialog = () => {
  showHelpLimitDialog.value = false
}

const closeCycleLimitDialog = () => {
  showCycleLimitDialog.value = false
}

// ğŸ”¥ å®šä¹‰æ¶ˆæ¯ç±»å‹
interface Message {
  id?: string
  type: 'user' | 'ai' | 'system'
  content: string
  step: number
  stage?: number
  timestamp: string | Date
}

// ğŸ”¥ å®šä¹‰å­˜å‚¨çš„æ¶ˆæ¯ç±»å‹
interface StoredMessage {
  id: string
  type: 'user' | 'ai' | 'system'
  content: string
  timestamp: string
  stage?: number
  step?: number
}

// å®šä¹‰APIå“åº”ç±»å‹
interface APIResponse {
  response: string
  metadata?: {
    step?: number
    stage?: number
    guidanceMode?: string
    suggestsCompletion?: boolean
  }
}

// ğŸ”¥ å®šä¹‰ event_data çš„ç±»å‹
interface EventData {
  helpMode?: 'refine' | 'example' | 'custom'
  customQuestion?: string
  actualRequest?: string
  answerLength?: number
  stage?: number
  currentInputLength?: number
  hasInput?: boolean
  userDisplayMessage?: string
  helpCycle?: number
  availableModes?: string
  cycleUsedModes?: string
  remainingCycles?: number
  [key: string]: string | number | boolean | undefined
}

// å®šä¹‰æ•°æ®åº“ä¿å­˜çš„æ•°æ®ç»“æ„
interface ConversationData {
  sessionId: string
  step: number
  stage: number
  userInput: string
  aiResponse: string
  conversationCount: number
  timestamp: Date
  context: string
  experimentId?: string
  studentName?: string
  event_name?: string
  event_data?: EventData
}

// ğŸ”¥ å®šä¹‰ Step3 æ•°æ®ç»“æ„
interface Step3Data {
  sessionId: string
  conversationCount: number
  stageCompletionStatus: boolean[]
  messages: StoredMessage[]
  currentStage: number
  isCompleted: boolean
  helpSystem?: {
    totalCycles: number
    maxCycles: number
    currentCycleUsed: {
      refine: boolean
      example: boolean
      custom: boolean
    }
    isInCycle: boolean
  }
  // ğŸ”¥ æ–°å¢å¿«ç…§å­—æ®µ
  finalAnswerSnapshot?: string
  finalAnswerConfirmed?: boolean
}

// ğŸ”¥ ä»å­˜å‚¨ä¸­æ¢å¤æˆ–åˆå§‹åŒ–å¯¹è¯æ•°æ®
const rawStepData = simpleStorage.getStepData(3) as Step3Data | null

const conversationData = reactive<{
  sessionId: string
  conversationCount: number
  stageCompletionStatus: boolean[]
  messages: Message[]
  currentStage: number
  isCompleted: boolean
}>(
  rawStepData
    ? {
        sessionId: rawStepData.sessionId,
        conversationCount: rawStepData.conversationCount,
        stageCompletionStatus: rawStepData.stageCompletionStatus,
        messages: rawStepData.messages.map(
          (msg: StoredMessage): Message => ({
            id: msg.id,
            type: msg.type,
            content: msg.content,
            step: msg.step || 3,
            stage: msg.stage || 1,
            timestamp: msg.timestamp,
          }),
        ),
        currentStage: 1, // Step3 å§‹ç»ˆä¸ºå•é˜¶æ®µ
        isCompleted: rawStepData.isCompleted || false,
      }
    : {
        sessionId: simpleStorage.getSessionId(),
        conversationCount: 0,
        stageCompletionStatus: [false],
        messages: [],
        currentStage: 1,
        isCompleted: false,
      },
)

// ğŸ”¥ æ¢å¤å¸®åŠ©ç³»ç»ŸçŠ¶æ€
if (rawStepData?.helpSystem) {
  Object.assign(helpSystem, rawStepData.helpSystem)
}

// ğŸ”¥ æ–°å¢ï¼šæ¢å¤å¿«ç…§æ•°æ®
if (rawStepData?.finalAnswerSnapshot) {
  finalAnswerSnapshot.value = rawStepData.finalAnswerSnapshot
}
if (rawStepData?.finalAnswerConfirmed !== undefined) {
  finalAnswerConfirmed.value = rawStepData.finalAnswerConfirmed
}

// çŠ¶æ€ç®¡ç†
const showInfoCard = ref(false)
const showPrompt = ref(false)
const showAnswerArea = ref(false)
const showConversationWarning = ref(false)
const showConfirmDialog = ref(false)
const userAnswer = ref('')
const answerSubmitted = ref(false)
const isGenerating = ref(false)
const loadingStep = ref(1)

// ğŸ”¥ å¯¹è¯è½®æ¬¡æ§åˆ¶ï¼ˆä¿®æ”¹ä¸º5ï¼‰
const MAX_CONVERSATIONS = 5

// è®¡ç®—å±æ€§
const conversationCount = computed(() => conversationData.conversationCount)
const currentStage = computed(() => conversationData.currentStage)
const messages = computed(() => conversationData.messages)

const canSubmit = computed(() => userAnswer.value.trim().length > 0)
const isConversationLimitReached = computed(() => conversationCount.value >= MAX_CONVERSATIONS)

const inputPlaceholder = computed(() => {
  if (isConversationLimitReached.value) {
    return 'å·²è¾¾åˆ°æœ€å¤§å¯¹è¯è½®æ¬¡ï¼Œè¯·ç‚¹å‡»"ç»§ç»­ä¸‹ä¸€æ­¥"è¿›å…¥ä¸‹ä¸€é˜¶æ®µ'
  }
  return 'è¯·æå‡ºä¸¤ä¸ªå…·ä½“çš„èŠ‚èƒ½ç­–ç•¥ï¼Œå¹¶åˆ†æå®ƒä»¬çš„ä¼˜åŠ£......'
})

// æ»šåŠ¨å®¹å™¨å¼•ç”¨
const chatScrollArea = ref<HTMLElement | null>(null)

// ğŸ”¥ ç›‘å¬å¯¹è¯è½®æ¬¡å˜åŒ–ï¼ˆä¿®æ”¹é˜ˆå€¼ä¸º4ï¼‰
watch(conversationCount, async (newCount) => {
  if (newCount >= 4) {
    showConversationWarning.value = true
    nextTick(() => {
      if (chatScrollArea.value) {
        chatScrollArea.value.scrollTo({
          top: 0,
          behavior: 'smooth',
        })
      }
    })
  }

  // ğŸ”¥ åŸ‹ç‚¹ - è¾¾åˆ°å¯¹è¯ä¸Šé™
  if (newCount === MAX_CONVERSATIONS) {
    await trackStep3Event(
      'step3_conversation_limit_reached',
      conversationData.sessionId,
      currentStage.value,
      newCount,
      {
        finalStage: currentStage.value,
      },
    )
  }
})

// ğŸ”¥ ä¿å­˜å¸®åŠ©ç³»ç»ŸçŠ¶æ€åˆ° localStorage
function saveHelpSystemState() {
  const stepData = simpleStorage.getStepData(3) as Step3Data | null
  if (stepData) {
    stepData.helpSystem = {
      totalCycles: helpSystem.totalCycles,
      maxCycles: helpSystem.maxCycles,
      currentCycleUsed: { ...helpSystem.currentCycleUsed },
      isInCycle: helpSystem.isInCycle,
    }
    simpleStorage.saveStepData(3, stepData)
    console.log('ğŸ’¾ Step3 - å¸®åŠ©ç³»ç»ŸçŠ¶æ€å·²ä¿å­˜')
  }
}

// ğŸ”¥ æ ¸å¿ƒæäº¤å‡½æ•°
async function submitAnswer() {
  if (!canSubmit.value || isConversationLimitReached.value) return

  simpleStorage.updateConversationCount(3, conversationData.conversationCount + 1)
  conversationData.conversationCount += 1

  addMessage('user', userAnswer.value, currentStage.value)

  // ğŸ”¥ æ–°å¢ï¼šä¿å­˜æœ¬è½®è¾“å…¥ä½œä¸ºå¿«ç…§
  const currentAnswer = userAnswer.value
  finalAnswerSnapshot.value = currentAnswer

  // ğŸ”¥ é‡ç½®å¸®åŠ©å‘¨æœŸ
  if (helpSystem.isInCycle) {
    console.log(`ğŸ”„ Step3 - é‡ç½®å¸®åŠ©å‘¨æœŸï¼Œå·²ä½¿ç”¨å‘¨æœŸæ•°: ${helpSystem.totalCycles}`)
    helpSystem.isInCycle = false
    helpSystem.currentCycleUsed = {
      refine: false,
      example: false,
      custom: false,
    }
    saveHelpSystemState()
  }

  // ğŸ”¥ åŸ‹ç‚¹ - æäº¤ç­”æ¡ˆ
  await trackStep3Event(
    'step3_answer_submit',
    conversationData.sessionId,
    currentStage.value,
    conversationData.conversationCount,
    {
      answerLength: userAnswer.value.length,
      stage: currentStage.value,
    },
  )

  userAnswer.value = ''
  isGenerating.value = true
  loadingStep.value = 1

  const stepInterval = setInterval(() => {
    if (loadingStep.value < 3) {
      loadingStep.value++
    }
  }, 5000)

  try {
    const response = await callAIAPI(currentAnswer)
    clearInterval(stepInterval)

    addMessage('ai', response)

    answerSubmitted.value = true

    saveToStorage()

    emit('update-progress', 3)
    emit('show-next-steps')
  } catch (error) {
    clearInterval(stepInterval)
    console.error('âŒ Step3 - AI API è°ƒç”¨å¤±è´¥:', error)
    addMessage('ai', 'æŠ±æ­‰ï¼Œç³»ç»Ÿæš‚æ—¶æ— æ³•å¤„ç†æ‚¨çš„å›ç­”ï¼Œè¯·ç¨åé‡è¯•ã€‚')
    saveToStorage()
  } finally {
    isGenerating.value = false
    loadingStep.value = 1
  }
}

// ğŸ”¥ æ‰“å¼€å¸®åŠ©å¼¹çª—
function requestHelp() {
  if (isGenerating.value || isConversationLimitReached.value) return

  // æ£€æŸ¥æ˜¯å¦è¿˜èƒ½ä½¿ç”¨å¸®åŠ©åŠŸèƒ½
  if (!canUseHelp.value) {
    showHelpLimitDialog.value = true
    return
  }

  // å¦‚æœä¸åœ¨å‘¨æœŸä¸­ï¼Œå¼€å¯æ–°å‘¨æœŸ
  if (!helpSystem.isInCycle) {
    helpSystem.totalCycles++
    helpSystem.isInCycle = true
    console.log(`ğŸ†• Step3 - å¼€å¯ç¬¬ ${helpSystem.totalCycles} ä¸ªå¸®åŠ©å‘¨æœŸ`)
  }

  // æ£€æŸ¥å½“å‰å‘¨æœŸæ˜¯å¦è¿˜æœ‰å¯ç”¨æ¨¡å¼
  if (!hasAvailableModesInCycle.value) {
    showCycleLimitDialog.value = true
    return
  }

  // ğŸ”¥ åŸ‹ç‚¹ - ç‚¹å‡»å¸®åŠ©æŒ‰é’®
  trackStep3Event(
    'step3_help_button_click',
    conversationData.sessionId,
    currentStage.value,
    conversationData.conversationCount,
    {
      currentInputLength: userAnswer.value.length,
      hasInput: userAnswer.value.length > 0,
      helpCycle: helpSystem.totalCycles,
      availableModes: Object.entries(availableHelpModes.value)
        .filter(([_, available]) => available)
        .map(([mode]) => mode)
        .join(','),
    },
  )

  showHelpDialog.value = true
}

// å…³é—­å¸®åŠ©å¼¹çª—
function closeHelpDialog() {
  showHelpDialog.value = false
  helpMode.value = null
  customQuestion.value = ''
}

// ğŸ”¥ é€‰æ‹©å¸®åŠ©æ¨¡å¼
function selectHelpMode(mode: 'refine' | 'example' | 'custom') {
  if (!availableHelpModes.value[mode]) {
    console.log(`âŒ Step3 - æ¨¡å¼ ${mode} åœ¨å½“å‰å‘¨æœŸå·²ä½¿ç”¨`)
    return
  }

  helpMode.value = mode

  if (mode !== 'custom') {
    executeHelp(mode)
  }
}

// æäº¤è‡ªå®šä¹‰é—®é¢˜
function submitCustomQuestion() {
  if (!customQuestion.value.trim()) {
    return
  }
  executeHelp('custom', customQuestion.value)
}

// ğŸ”¥ æ‰§è¡Œå¸®åŠ©è¯·æ±‚
async function executeHelp(mode: 'refine' | 'example' | 'custom', customQuestionText?: string) {
  showHelpDialog.value = false

  // æ ‡è®°è¯¥æ¨¡å¼åœ¨å½“å‰å‘¨æœŸå·²ä½¿ç”¨
  helpSystem.currentCycleUsed[mode] = true
  saveHelpSystemState()

  // æ ¹æ®å¸®åŠ©æ¨¡å¼ç”Ÿæˆå¯è¯»çš„ç”¨æˆ·æ¶ˆæ¯
  let userDisplayMessage = ''
  let helpRequestContent = ''
  let helpContextType = ''

  switch (mode) {
    case 'refine':
      userDisplayMessage = `ğŸ’¬ å¸®æˆ‘å®Œå–„å†…å®¹ï¼š${userAnswer.value || 'ï¼ˆå½“å‰è¾“å…¥å†…å®¹ï¼‰'}`
      helpRequestContent = '[REFINE_CONTENT]' + (userAnswer.value || 'å½“å‰è¾“å…¥å†…å®¹éœ€è¦å®Œå–„')
      helpContextType = 'refine_content'
      break
    case 'example':
      userDisplayMessage = 'ğŸ’¡ èƒ½ç»™æˆ‘çœ‹çœ‹ä¾‹å­å—ï¼Ÿ'
      helpRequestContent = '[REQUEST_EXAMPLE]' + 'éœ€è¦ä¸€ä¸ªå‚è€ƒç¤ºä¾‹'
      helpContextType = 'request_example'
      break
    case 'custom':
      userDisplayMessage = `âœï¸ æˆ‘æƒ³é—®ï¼š${customQuestionText || 'éœ€è¦å…·ä½“æŒ‡å¯¼'}`
      helpRequestContent = '[CUSTOM_QUESTION]' + (customQuestionText || 'éœ€è¦å…·ä½“æŒ‡å¯¼')
      helpContextType = 'custom_question'
      break
  }

  // æ˜¾ç¤ºç”¨æˆ·çš„å¸®åŠ©è¯·æ±‚æ¶ˆæ¯
  addMessage('user', userDisplayMessage, currentStage.value)

  // å¢åŠ å¯¹è¯è®¡æ•°
  simpleStorage.updateConversationCount(3, conversationData.conversationCount + 1)
  conversationData.conversationCount += 1

  // ğŸ”¥ åŸ‹ç‚¹ - ä½¿ç”¨å¸®åŠ©
  await trackStep3Event(
    'step3_help_request',
    conversationData.sessionId,
    currentStage.value,
    conversationData.conversationCount,
    {
      helpMode: mode,
      helpCycle: helpSystem.totalCycles,
      cycleUsedModes: Object.entries(helpSystem.currentCycleUsed)
        .filter(([_, used]) => used)
        .map(([mode]) => mode)
        .join(','),
      remainingCycles: helpSystem.maxCycles - helpSystem.totalCycles,
    },
  )

  isGenerating.value = true
  loadingStep.value = 1

  const stepInterval = setInterval(() => {
    if (loadingStep.value < 2) {
      loadingStep.value++
    }
  }, 2000)

  try {
    const helpResponse = await callEnhancedHelpAPI(mode, customQuestionText, helpRequestContent)

    clearInterval(stepInterval)

    addMessage('ai', helpResponse, currentStage.value)

    await saveConversationToDB({
      sessionId: conversationData.sessionId,
      step: 3,
      stage: currentStage.value,
      userInput: userDisplayMessage,
      aiResponse: helpResponse,
      conversationCount: conversationData.conversationCount,
      timestamp: new Date(),
      context: `stage_${currentStage.value}_${helpContextType}`,
      event_data: {
        helpMode: mode,
        customQuestion: mode === 'custom' ? customQuestionText : undefined,
        actualRequest: helpRequestContent,
      },
    })

    saveToStorage()
  } catch (error) {
    clearInterval(stepInterval)
    console.error('âŒ Step3 - è·å–æ™ºèƒ½å¸®åŠ©å¤±è´¥:', error)

    const fallbackTexts: Record<string, string> = {
      refine: 'è¯•ç€ä»å¤šä¸ªç»´åº¦åˆ†æç­–ç•¥çš„ä¼˜åŠ£ï¼Œæ¯”å¦‚æˆæœ¬ã€æ•ˆæœã€é€‚ç”¨æ€§ç­‰ã€‚',
      example: 'æƒ³æƒ³è‡ªç„¶é€šé£å’Œæ™ºèƒ½ç©ºè°ƒå„æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿå®ƒä»¬é€‚åˆåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨ï¼Ÿ',
      custom: 'æ ¹æ®ä½ çš„é—®é¢˜ï¼Œå»ºè®®ä»ç­–ç•¥å¯¹æ¯”å’Œå®é™…åº”ç”¨åœºæ™¯çš„è§’åº¦æ¥æ€è€ƒã€‚',
    }

    addMessage('ai', fallbackTexts[mode] || fallbackTexts.custom, currentStage.value)
    saveToStorage()
  } finally {
    isGenerating.value = false
    loadingStep.value = 1

    helpMode.value = null
    customQuestion.value = ''
  }
}

// ğŸ”¥ è°ƒç”¨å¢å¼ºçš„å¸®åŠ©API
async function callEnhancedHelpAPI(
  helpMode: 'refine' | 'example' | 'custom' = 'custom',
  customQuestionText?: string,
  helpRequestContent?: string,
): Promise<string> {
  try {
    const conversationHistory = conversationData.messages
      .filter((msg) => msg.step === 3)
      .map((msg) => ({
        type: msg.type,
        content: msg.content,
        step: msg.step,
        stage: msg.stage || 1,
        timestamp: msg.timestamp,
      }))

    let actualHelpRequest = helpRequestContent
    if (!actualHelpRequest) {
      switch (helpMode) {
        case 'refine':
          actualHelpRequest = '[REFINE_CONTENT]' + (userAnswer.value || 'å½“å‰è¾“å…¥å†…å®¹éœ€è¦å®Œå–„')
          break
        case 'example':
          actualHelpRequest = '[REQUEST_EXAMPLE]' + 'éœ€è¦ä¸€ä¸ªå‚è€ƒç¤ºä¾‹'
          break
        case 'custom':
          actualHelpRequest = '[CUSTOM_QUESTION]' + (customQuestionText || 'éœ€è¦å…·ä½“æŒ‡å¯¼')
          break
      }
    }

    console.log('ğŸ“¤ Step3 æ™ºèƒ½å¸®åŠ© - å‘é€å¯¹è¯å†å²:', {
      count: conversationHistory.length,
      helpMode,
      history: conversationHistory,
    })

    const response = await fetch('/api/ai/analyze', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Experiment-ID': localStorage.getItem('experimentId') || '',
      },
      body: JSON.stringify({
        userAnswer: actualHelpRequest,
        context: {
          isHelpRequest: true,
          helpMode,
          customQuestion: customQuestionText,
          currentUserInput: userAnswer.value,
          recentQuestions: getRecentAIQuestions(conversationData.messages, 3),
          strategyFocus: true,
          currentStage: currentStage.value,
        },
        step: 3,
        stage: currentStage.value,
        sessionId: conversationData.sessionId,
        conversationHistory,
        followUpContext: {
          currentStage: currentStage.value,
          conversationCount: conversationData.conversationCount,
          isSmartHintRequest: true,
          helpType:
            helpMode === 'refine'
              ? 'refine_content'
              : helpMode === 'example'
                ? 'request_example'
                : 'custom_question',
          needsGuidance: true,
          needsContinuity: true,
        },
      }),
    })

    if (!response.ok) {
      throw new Error(`API Error: ${response.statusText}`)
    }

    const data = await response.json()

    console.log('ğŸ“¥ Step3 æ™ºèƒ½å¸®åŠ© - æ”¶åˆ°å“åº”:', {
      response: data.response,
      isSmartHint: data.metadata?.isSmartHint,
      helpMode,
    })

    return data.response || 'æ ¹æ®ä½ ç›®å‰çš„æ€è€ƒï¼Œè¯•ç€ä»ç­–ç•¥å¯¹æ¯”å’Œå®æ–½å¯è¡Œæ€§çš„è§’åº¦æ¥åˆ†æã€‚'
  } catch (error) {
    console.error('âŒ Step3 - æ™ºèƒ½å¸®åŠ©APIè°ƒç”¨å¤±è´¥:', error)
    throw error
  }
}

const handleInput = () => {
  // è¾“å…¥å¤„ç†
}

const handleNextStep = () => {
  // ğŸ”¥ åˆå§‹åŒ–å¯ç¼–è¾‘å†…å®¹ä¸ºå½“å‰å¿«ç…§
  editableFinalAnswer.value = finalAnswerSnapshot.value
  showConfirmDialog.value = true
}

const closeConfirmDialog = () => {
  showConfirmDialog.value = false
}

// ğŸ”¥ ç¡®è®¤è¿›å…¥ä¸‹ä¸€æ­¥
const confirmNextStep = async () => {
  // ğŸ”¥ ä½¿ç”¨ç¼–è¾‘åçš„å†…å®¹ä½œä¸ºæœ€ç»ˆå¿«ç…§
  finalAnswerSnapshot.value = editableFinalAnswer.value.trim()
  finalAnswerConfirmed.value = true
  showConfirmDialog.value = false

  // ğŸ”¥ 1. ä¿å­˜åˆ° localStorageï¼ˆStep6 ä¼šè¯»å–ï¼‰
  simpleStorage.setItem('step3_final_answer', {
    content: finalAnswerSnapshot.value,
    confirmedAt: new Date().toISOString(),
  })

  // ğŸ”¥ 2. åŸ‹ç‚¹ - ç‚¹å‡»ç»§ç»­ä¸‹ä¸€æ­¥
  await trackStep3Event(
    'step3_next_step_click',
    conversationData.sessionId,
    currentStage.value,
    conversationData.conversationCount,
    {
      answerSubmitted: answerSubmitted.value,
      finalAnswerLength: finalAnswerSnapshot.value.length,
      wasEdited: editableFinalAnswer.value !== finalAnswerSnapshot.value,
    },
  )

  // ğŸ”¥ 3. ä¿å­˜åˆ° storageï¼ˆåŒ…å«å¿«ç…§ï¼‰
  saveToStorage()

  // ğŸ”¥ 4. è·³è½¬ä¸‹ä¸€æ­¥
  goToNextStep()
}

const goToNextStep = () => {
  simpleStorage.updateCurrentStep(4)
  saveProgressToLocal()
  router.push('/experiment/step4')
}

// ğŸ”¥ æ·»åŠ æ¶ˆæ¯
const addMessage = (type: 'ai' | 'user' | 'system', content: string, stage?: number) => {
  const messageId = `${type}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  const message: Message = {
    id: messageId,
    type,
    content,
    step: 3,
    stage: stage || 1,
    timestamp: new Date(),
  }

  messages.value.push(message)

  simpleStorage.addMessage(3, type, content, stage || 1)

  nextTick(() => {
    scrollToBottom()
  })
}

const scrollToBottom = () => {
  if (chatScrollArea.value) {
    chatScrollArea.value.scrollTop = chatScrollArea.value.scrollHeight
  }
}

const formatTime = (timestamp: Date | string) => {
  const date = typeof timestamp === 'string' ? new Date(timestamp) : timestamp
  return date.toLocaleTimeString('zh-CN', {
    hour: '2-digit',
    minute: '2-digit',
  })
}

const saveProgressToLocal = () => {
  const progressData = {
    conversationCount: conversationCount.value,
    answerSubmitted: answerSubmitted.value,
    messages: messages.value.map((msg) => ({
      id: msg.id,
      type: msg.type,
      content: msg.content,
      timestamp: typeof msg.timestamp === 'string' ? msg.timestamp : msg.timestamp.toISOString(),
    })),
    completedAt: new Date().toISOString(),
  }

  localStorage.setItem('step3_progress', JSON.stringify(progressData))
}

// ğŸ”¥ è·å–æœ€è¿‘é—®é¢˜ç”¨äºä¸Šä¸‹æ–‡
const getRecentAIQuestions = (messages: Message[], count = 2): string => {
  return messages
    .filter((m) => m.type === 'ai')
    .slice(-count)
    .map((m) => m.content)
    .join('ï¼›')
}

// ğŸ”¥ API è°ƒç”¨å‡½æ•°
const callAIAPI = async (answer: string): Promise<string> => {
  try {
    const sessionId = simpleStorage.getSessionId()

    const conversationHistory = conversationData.messages
      .filter((msg) => msg.step === 3)
      .map((msg) => ({
        type: msg.type,
        content: msg.content,
        step: msg.step,
        stage: msg.stage || 1,
        timestamp: msg.timestamp,
      }))

    console.log('ğŸ“¤ Step3 - å‘é€ç»™åç«¯çš„å¯¹è¯å†å²:', {
      count: conversationHistory.length,
      history: conversationHistory,
      userAnswer: answer.substring(0, 50) + (answer.length > 50 ? '...' : ''),
    })

    const response = await fetch('/api/ai/analyze', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Experiment-ID': localStorage.getItem('experimentId') || '',
      },
      body: JSON.stringify({
        userAnswer: answer,
        context: {
          recentQuestions: getRecentAIQuestions(conversationData.messages, 3),
          isExam: false,
          requireQuiet: false,
          strategyFocus: true,
        },
        step: 3,
        stage: 1,
        sessionId: sessionId,
        conversationHistory,
        followUpContext: {
          conversationCount: conversationData.conversationCount,
          needsContinuity: true,
        },
      }),
    })

    if (!response.ok) {
      throw new Error(`API Error: ${response.statusText}`)
    }

    const data = await response.json()

    console.log('ğŸ“¥ Step3 - æ”¶åˆ°åç«¯å“åº”:', {
      response: data.response?.substring(0, 100) + (data.response?.length > 100 ? '...' : ''),
      metadata: data.metadata,
    })

    const aiResponse = data.response || 'è¯·ç»§ç»­é˜è¿°ä½ çš„ç­–ç•¥æ€è·¯ã€‚'

    await saveConversationToDB({
      sessionId: conversationData.sessionId,
      step: 3,
      stage: 1,
      userInput: answer,
      aiResponse: aiResponse,
      conversationCount: conversationData.conversationCount,
      timestamp: new Date(),
      context: 'strategy_development',
    })

    return aiResponse
  } catch (error) {
    console.error('âŒ Step3 - AI API è°ƒç”¨å¤±è´¥:', error)
    const fallbackResponse = 'è¯·ç»§ç»­é˜è¿°ä½ çš„ç­–ç•¥æ€è·¯ã€‚'

    await saveConversationToDB({
      sessionId: conversationData.sessionId,
      step: 3,
      stage: 1,
      userInput: answer,
      aiResponse: fallbackResponse,
      conversationCount: conversationData.conversationCount,
      timestamp: new Date(),
      context: 'strategy_development_fallback',
    })

    return fallbackResponse
  }
}

// ğŸ”¥ ä¿å­˜å¯¹è¯åˆ°æ•°æ®åº“
const saveConversationToDB = async (conversationDataPayload: ConversationData): Promise<void> => {
  try {
    const experimentId = localStorage.getItem('experimentId')
    const studentName = localStorage.getItem('studentName')

    await fetch('/api/conversations/save', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Experiment-ID': experimentId || '',
      },
      body: JSON.stringify({
        ...conversationDataPayload,
        experimentId,
        studentName,
      }),
    })

    console.log('âœ… Step3 - å¯¹è¯å·²ä¿å­˜åˆ°æ•°æ®åº“')
  } catch (error) {
    console.error('âŒ Step3 - ä¿å­˜å¯¹è¯å¤±è´¥:', error)
  }
}

const saveToStorage = () => {
  const stepData = {
    sessionId: conversationData.sessionId,
    conversationCount: conversationData.conversationCount,
    stageCompletionStatus: [answerSubmitted.value],
    messages: messages.value.map((msg) => ({
      id: msg.id || `msg_${Date.now()}`,
      type: msg.type,
      content: msg.content,
      timestamp: typeof msg.timestamp === 'string' ? msg.timestamp : msg.timestamp.toISOString(),
      step: 3,
      stage: 1,
    })),
    currentStage: 1,
    isCompleted: answerSubmitted.value,
    helpSystem: {
      totalCycles: helpSystem.totalCycles,
      maxCycles: helpSystem.maxCycles,
      currentCycleUsed: { ...helpSystem.currentCycleUsed },
      isInCycle: helpSystem.isInCycle,
    },
    // ğŸ”¥ æ–°å¢ï¼šä¿å­˜å¿«ç…§
    finalAnswerSnapshot: finalAnswerSnapshot.value,
    finalAnswerConfirmed: finalAnswerConfirmed.value,
  }

  simpleStorage.saveStepData(3, stepData)

  console.log('ğŸ’¾ Step3 - æ•°æ®å·²ä¿å­˜åˆ°å­˜å‚¨:', {
    conversationCount: stepData.conversationCount,
    messagesCount: stepData.messages.length,
    hasSnapshot: !!finalAnswerSnapshot.value,
    snapshotLength: finalAnswerSnapshot.value.length,
  })
}

// ç”Ÿå‘½å‘¨æœŸ
const showContentSequentially = async () => {
  const stepData = simpleStorage.getStepData(3) as Step3Data | null
  if (stepData) {
    conversationData.conversationCount = stepData.conversationCount || 0
    answerSubmitted.value = stepData.isCompleted || false

    conversationData.messages = stepData.messages.map(
      (msg: StoredMessage): Message => ({
        id: msg.id,
        type: msg.type,
        content: msg.content,
        step: msg.step || 3,
        stage: msg.stage || 1,
        timestamp: msg.timestamp,
      }),
    )

    console.log('ğŸ’¾ Step3 - ä»å­˜å‚¨æ¢å¤æ•°æ®:', {
      conversationCount: conversationData.conversationCount,
      messagesCount: conversationData.messages.length,
    })
  }

  showInfoCard.value = true
  await new Promise((resolve) => setTimeout(resolve, 800))

  showPrompt.value = true
  await new Promise((resolve) => setTimeout(resolve, 1000))

  showAnswerArea.value = true

  if (messages.value.length > 0) {
    nextTick(() => {
      scrollToBottom()
    })
  }
}

// ğŸ”¥ ç»„ä»¶æŒ‚è½½æ—¶
onMounted(async () => {
  console.log('ğŸ¬ Step3 ç»„ä»¶å·²æŒ‚è½½')

  // ğŸ”¥ åŸ‹ç‚¹ - è¿›å…¥ Step3
  await trackStep3Event(
    'step3_enter',
    conversationData.sessionId,
    conversationData.currentStage,
    conversationData.conversationCount,
    {
      initialStage: conversationData.currentStage,
      hasHistory: conversationData.messages.length > 0,
    },
  )

  showContentSequentially()
})
</script>

<style scoped>
/* ==================== åŸºç¡€å®¹å™¨ ==================== */
.step-three-container {
  height: 100%;
  display: flex;
  flex-direction: column;
  background: #ffffffdd;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
}

/* ==================== å¯¹è¯è½®æ¬¡é™åˆ¶è­¦å‘Š ==================== */
.conversation-limit-warning {
  position: sticky;
  top: 0;
  z-index: 10;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 2px solid #f59e0b;
  border-radius: 0 0 12px 12px;
  margin: 0;
  opacity: 0;
  transform: translateY(-100%);
  transition: all 0.5s ease-out;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
  max-height: 0;
  overflow: hidden;
}

.conversation-limit-warning.warning-visible {
  opacity: 1;
  transform: translateY(0);
  max-height: 200px;
}

.warning-content {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.5rem;
}

.warning-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
  animation: warningPulse 2s infinite;
}

.warning-text {
  color: #92400e;
  font-weight: 600;
  font-size: 0.95rem;
  line-height: 1.4;
}

@keyframes warningPulse {
  0%,
  100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.8;
  }
}

/* ==================== å¯¹è¯æ»šåŠ¨åŒºåŸŸ ==================== */
.chat-scroll-area {
  flex: 1;
  overflow-y: auto;
  padding: 1.5rem;
  padding-bottom: 0;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  scrollbar-width: thin;
  scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
}

.chat-scroll-area::-webkit-scrollbar {
  width: 6px;
}

.chat-scroll-area::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.05);
  border-radius: 3px;
}

.chat-scroll-area::-webkit-scrollbar-thumb {
  background: rgba(102, 126, 234, 0.3);
  border-radius: 3px;
}

.chat-scroll-area::-webkit-scrollbar-thumb:hover {
  background: rgba(102, 126, 234, 0.5);
}

/* ==================== å¯¹è¯æ¶ˆæ¯åŒºåŸŸ ==================== */
.chat-messages {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* ==================== ä¿¡æ¯å¡ç‰‡æ ·å¼ ==================== */
.info-card-section {
  flex-shrink: 0;
}

.info-card {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 2px solid #0ea5e9;
  border-radius: 20px;
  padding: 1.5rem;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.6s ease-out;
  position: relative;
}

.info-card.card-visible {
  opacity: 1;
  transform: translateY(0);
}

.card-header {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  margin-bottom: 1.5rem;
  position: relative;
}

.card-icon {
  background: linear-gradient(45deg, #0ea5e9, #0284c7);
  width: 3rem;
  height: 3rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
}

.card-title {
  color: #0c4a6e;
  font-size: 1rem;
  line-height: 1.6;
  font-weight: 500;
  flex: 1;
}

.card-content h4 {
  color: #0c4a6e;
  font-size: 0.9rem;
  margin: 0 0 1rem 0;
  font-weight: 600;
}

.chart-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  align-items: flex-start;
}

/* ç­–ç•¥å¯¹æ¯”è¡¨ */
.strategy-comparison h5,
.decision-factors h5 {
  color: #374151;
  font-size: 0.85rem;
  margin: 0 0 0.75rem 0;
  font-weight: 600;
  text-align: center;
  padding: 0.5rem;
  background: rgba(14, 165, 233, 0.1);
  border-radius: 6px;
  border-left: 3px solid #0ea5e9;
}

.strategy-comparison {
  background: white;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.strategy-table {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.strategy-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1.5fr;
  gap: 0.5rem;
  align-items: center;
}

.strategy-row.header {
  font-weight: 600;
  font-size: 0.75rem;
  color: #6b7280;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 0.5rem;
}

.strategy-cell {
  padding: 0.5rem 0.25rem;
  font-size: 0.75rem;
  text-align: center;
}

.strategy-icon {
  margin-right: 0.25rem;
}

.effect-bar,
.cost-indicator {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-weight: 600;
  font-size: 0.7rem;
}

.effect-bar.high,
.cost-indicator.high {
  background: #fef3c7;
  color: #92400e;
}

.effect-bar.medium,
.cost-indicator.medium {
  background: #dbeafe;
  color: #1e40af;
}

.effect-bar.low,
.cost-indicator.low {
  background: #d1fae5;
  color: #065f46;
}

/* å†³ç­–è¦ç´ åˆ†æ */
.decision-factors {
  background: white;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.factors-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
}

.factor-item {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
  padding: 0.75rem;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.factor-icon {
  font-size: 1rem;
  flex-shrink: 0;
}

.factor-content {
  flex: 1;
}

.factor-title {
  font-size: 0.75rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.25rem;
}

.factor-desc {
  font-size: 0.7rem;
  color: #6b7280;
  line-height: 1.3;
}

/* ==================== å¯¹è¯æ¶ˆæ¯æ ·å¼ ==================== */
.message {
  display: flex;
  margin-bottom: 1.5rem;
  animation: slideIn 0.3s ease-out;
}

.message.user {
  flex-direction: row-reverse;
}

.message-avatar {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  flex-shrink: 0;
  color: white;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.message.ai .message-avatar {
  background: linear-gradient(45deg, #4caf50, #2196f3);
  margin-right: 0.75rem;
}

.message.user .message-avatar {
  background: linear-gradient(45deg, #667eea, #764ba2);
  margin-left: 0.75rem;
}

.message-content {
  max-width: 70%;
  background: #f1f5f9;
  padding: 1rem 1.25rem;
  border-radius: 18px;
  position: relative;
  font-size: 0.95rem;
  line-height: 1.5;
  color: #334155;
  border: 1px solid #e2e8f0;
}

.message.user .message-content {
  background: linear-gradient(45deg, #667eea, #764ba2);
  color: white;
  border-color: transparent;
}

.message-text {
  margin-bottom: 0.5rem;
}

.message-time {
  font-size: 0.75rem;
  opacity: 0.7;
  text-align: right;
  margin-top: 0.25rem;
}

.message.user .message-time {
  color: rgba(255, 255, 255, 0.8);
}

/* ==================== åŠ è½½åŠ¨ç”»æ ·å¼ ==================== */
.loading-message {
  animation: slideIn 0.3s ease-out;
}

.loading-content {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 2px solid #0ea5e9;
  max-width: 80%;
}

.loading-animation {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  align-items: center;
}

.loading-dots {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #0ea5e9;
  animation: bounce 1.4s infinite ease-in-out;
}

.dot:nth-child(1) {
  animation-delay: -0.32s;
}
.dot:nth-child(2) {
  animation-delay: -0.16s;
}
.dot:nth-child(3) {
  animation-delay: 0s;
}

@keyframes bounce {
  0%,
  80%,
  100% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  40% {
    transform: scale(1.2);
    opacity: 1;
  }
}

.loading-text {
  color: #0369a1;
  font-size: 0.9rem;
  text-align: center;
  font-weight: 500;
}

.loading-progress {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.progress-bar {
  width: 100%;
  height: 6px;
  background: #e0f2fe;
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #0ea5e9, #0284c7);
  border-radius: 3px;
  animation: progressAnimation 3s ease-in-out infinite;
}

@keyframes progressAnimation {
  0% {
    width: 0%;
  }
  50% {
    width: 60%;
  }
  100% {
    width: 90%;
  }
}

.progress-steps {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
}

.step {
  color: #94a3b8;
  transition: color 0.3s ease;
}

.step.active {
  color: #0369a1;
  font-weight: 600;
}

/* ==================== åº•éƒ¨ç”¨æˆ·è¾“å…¥åŒºåŸŸ ==================== */
.input-section {
  border-top: 1px solid #e2e8f0;
  background: white;
  padding: 1.5rem;
  flex-shrink: 0;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.6s ease-out;
  width: 100%;
}

.input-section.input-visible {
  opacity: 1;
  transform: translateY(0);
}

.input-container {
  width: 100%;
}

.user-input {
  width: 100%;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 1rem;
  font-size: 1rem;
  line-height: 1.5;
  color: #334155;
  background: #f8fafc;
  resize: vertical;
  min-height: 80px;
  font-family: inherit;
  transition:
    border-color 0.3s ease,
    background-color 0.3s ease;
  box-sizing: border-box;
}

.user-input:focus {
  outline: none;
  border-color: #3b82f6;
  background: white;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.user-input::placeholder {
  color: #94a3b8;
}

.user-input:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  background: #f1f5f9;
  border-color: #cbd5e1;
}

.input-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 1rem;
  gap: 1rem;
  width: 100%;
}

.help-button {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: linear-gradient(45deg, #f1f5f9, #e2e8f0);
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  padding: 0.75rem 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
  color: #475569;
  font-weight: 500;
}

.help-button:hover:not(:disabled) {
  background: linear-gradient(45deg, #e2e8f0, #cbd5e1);
  border-color: #94a3b8;
  transform: translateY(-1px);
}

.help-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.help-icon {
  font-size: 1rem;
}

/* ğŸ”¥ ä¿®æ”¹ï¼šå¸®åŠ©æŒ‰é’®å¾½ç«  - æ”¹ä¸ºä½è°ƒçš„è“è‰² */
.help-badge {
  display: inline-block;
  background: linear-gradient(45deg, #0ea5e9, #0284c7); /* æ”¹ä¸ºè“è‰² */
  color: white;
  font-size: 0.75rem;
  padding: 0.15rem 0.5rem;
  border-radius: 12px;
  margin-left: 0.5rem;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(14, 165, 233, 0.3); /* æ”¹ä¸ºè“è‰²é˜´å½± */
}

.action-buttons {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.submit-button,
.next-button {
  padding: 0.75rem 2rem;
  border-radius: 25px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.submit-button {
  background: linear-gradient(45deg, #0ea5e9, #0284c7);
  color: white;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
  position: relative;
}

.submit-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
}

.submit-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.next-button {
  background: linear-gradient(45deg, #10b981, #059669);
  color: white;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.next-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
}

/* æŒ‰é’®å†…åŠ è½½åŠ¨ç”» */
.button-loading-dots {
  display: inline-flex;
  gap: 3px;
  margin-right: 8px;
}

.button-dot {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: currentColor;
  animation: buttonBounce 1.4s infinite ease-in-out;
}

.button-dot:nth-child(1) {
  animation-delay: -0.32s;
}
.button-dot:nth-child(2) {
  animation-delay: -0.16s;
}
.button-dot:nth-child(3) {
  animation-delay: 0s;
}

@keyframes buttonBounce {
  0%,
  80%,
  100% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  40% {
    transform: scale(1.2);
    opacity: 1;
  }
}

/* ==================== å¸®åŠ©å¼¹çª—æ ·å¼ ==================== */
.help-dialog-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.3s ease-out;
}

.help-dialog {
  background: white;
  border-radius: 20px;
  padding: 0;
  max-width: 600px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s ease-out;
}

.help-dialog-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem 2rem;
  border-bottom: 2px solid #e2e8f0;
  position: sticky;
  top: 0;
  background: white;
  z-index: 1;
  border-radius: 20px 20px 0 0;
}

.help-dialog-icon {
  width: 3rem;
  height: 3rem;
  border-radius: 50%;
  background: linear-gradient(45deg, #3b82f6, #1d4ed8);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  flex-shrink: 0;
}

.help-dialog-header h3 {
  color: #1e293b;
  font-size: 1.3rem;
  margin: 0;
  font-weight: 600;
  flex: 1;
}

.close-button {
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  border: none;
  background: #f1f5f9;
  color: #64748b;
  font-size: 1.2rem;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.close-button:hover {
  background: #e2e8f0;
  color: #334155;
}

.help-dialog-content {
  padding: 2rem;
}

.help-dialog-description {
  color: #475569;
  font-size: 1rem;
  line-height: 1.6;
  margin: 0 0 1.5rem 0;
  text-align: center;
}

.help-options {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.help-option {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1.25rem;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: left;
  width: 100%;
}

.help-option:hover:not(:disabled) {
  border-color: #3b82f6;
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.help-option.active {
  border-color: #3b82f6;
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
}

.help-option:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.help-option.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.help-option.disabled:hover {
  transform: none;
  border-color: #e2e8f0;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.option-icon {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.option-content {
  flex: 1;
}

.option-title {
  font-size: 1rem;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 0.25rem;
}

.option-description {
  font-size: 0.85rem;
  color: #64748b;
  line-height: 1.4;
}

.option-arrow {
  font-size: 1.5rem;
  color: #94a3b8;
  flex-shrink: 0;
  transition: transform 0.3s ease;
}

.help-option:hover:not(:disabled) .option-arrow {
  transform: translateX(4px);
  color: #3b82f6;
}

.used-badge {
  display: inline-block;
  background: #e2e8f0;
  color: #64748b;
  font-size: 0.75rem;
  padding: 0.15rem 0.5rem;
  border-radius: 12px;
  margin-left: 0.5rem;
  font-weight: 500;
}

.help-cycle-info {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  margin-top: 1.5rem;
  padding: 1rem;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 1px solid #0ea5e9;
  border-radius: 8px;
  font-size: 0.9rem;
  color: #0369a1;
  font-weight: 500;
}

.cycle-icon {
  font-size: 1.1rem;
}

.cycle-tip {
  font-size: 0.85rem;
  color: #64748b;
}

/* è‡ªå®šä¹‰é—®é¢˜è¾“å…¥åŒºåŸŸ */
.custom-question-section {
  margin-top: 1.5rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 2px solid #f59e0b;
  border-radius: 12px;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.custom-question-input {
  width: 100%;
  box-sizing: border-box;
  border: 2px solid #f59e0b;
  border-radius: 8px;
  padding: 1rem;
  font-size: 0.95rem;
  line-height: 1.5;
  color: #334155;
  background: white;
  resize: vertical;
  min-height: 80px;
  font-family: inherit;
  transition: border-color 0.3s ease;
}

.custom-question-input:focus {
  outline: none;
  border-color: #f97316;
  box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
}

.custom-question-input::placeholder {
  color: #94a3b8;
}

.custom-question-actions {
  display: flex;
  gap: 1rem;
  margin-top: 1rem;
  justify-content: flex-end;
}

.cancel-custom-button,
.submit-custom-button {
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.cancel-custom-button {
  background: white;
  color: #64748b;
  border: 2px solid #e2e8f0;
}

.cancel-custom-button:hover {
  background: #f8fafc;
  border-color: #cbd5e1;
}

.submit-custom-button {
  background: linear-gradient(45deg, #f59e0b, #f97316);
  color: white;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.submit-custom-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
}

.submit-custom-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.help-tip {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 1px solid #f59e0b;
  border-radius: 8px;
  padding: 1rem;
  margin-top: 1rem;
  font-size: 0.9rem;
  color: #92400e;
  animation: slideDown 0.3s ease-out;
}

.tip-icon {
  font-size: 1.1rem;
  flex-shrink: 0;
}

/* ==================== å¸®åŠ©é™åˆ¶æç¤ºå¼¹çª— ==================== */
.help-limit-dialog {
  background: white;
  border-radius: 20px;
  padding: 2rem;
  max-width: 400px;
  width: 90%;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s ease-out;
}

.limit-dialog-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
}

.help-limit-dialog h3 {
  color: #1e293b;
  font-size: 1.2rem;
  margin: 0 0 1rem 0;
  font-weight: 600;
}

.help-limit-dialog p {
  color: #475569;
  font-size: 0.95rem;
  line-height: 1.6;
  margin: 0 0 1rem 0;
}

.limit-tip {
  color: #64748b;
  font-size: 0.9rem;
  line-height: 1.6;
  margin-top: 1rem;
}

.limit-confirm-button {
  padding: 0.75rem 2rem;
  border-radius: 25px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  background: linear-gradient(45deg, #3b82f6, #1d4ed8);
  color: white;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  margin-top: 1.5rem;
}

.limit-confirm-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
}

/* ==================== ç¡®è®¤å¼¹çª—æ ·å¼ ==================== */
.confirm-dialog-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.3s ease-out;
}

.confirm-dialog {
  background: white;
  border-radius: 20px;
  padding: 2rem;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s ease-out;
}

.dialog-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid #e2e8f0;
}

.dialog-icon {
  width: 3rem;
  height: 3rem;
  border-radius: 50%;
  background: linear-gradient(45deg, #0ea5e9, #0284c7);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  flex-shrink: 0;
}

.dialog-header h3 {
  color: #1e293b;
  font-size: 1.3rem;
  margin: 0;
  font-weight: 600;
}

.dialog-content {
  margin-bottom: 2rem;
}

.dialog-content p {
  color: #475569;
  font-size: 1rem;
  line-height: 1.6;
  margin-bottom: 1.5rem;
}

.completion-summary {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1rem;
}

.summary-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
  font-size: 0.95rem;
  color: #334155;
}

.summary-item:last-child {
  margin-bottom: 0;
}

.summary-icon {
  font-size: 1.1rem;
  flex-shrink: 0;
}

.dialog-warning {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 1px solid #f59e0b;
  border-radius: 8px;
  padding: 1rem;
  font-size: 0.9rem;
  color: #92400e;
}

.dialog-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
}

.cancel-button,
.confirm-button {
  padding: 0.75rem 2rem;
  border-radius: 25px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.cancel-button {
  background: #f1f5f9;
  color: #475569;
  border: 2px solid #e2e8f0;
}

.cancel-button:hover {
  background: #e2e8f0;
  transform: translateY(-1px);
}

.confirm-button {
  background: linear-gradient(45deg, #10b981, #059669);
  color: white;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.confirm-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
}

/* ==================== åŠ¨ç”» ==================== */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ==================== å“åº”å¼è®¾è®¡ ==================== */
@media (max-width: 768px) {
  .chart-container {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .factors-grid {
    grid-template-columns: 1fr;
    gap: 0.5rem;
  }

  .strategy-row {
    grid-template-columns: 1fr;
    gap: 0.25rem;
    text-align: left;
  }

  .strategy-row.header {
    display: none;
  }

  .strategy-cell {
    text-align: left;
    padding: 0.25rem;
  }

  .message-content {
    max-width: 85%;
  }

  .loading-content {
    max-width: 90%;
  }

  .input-toolbar {
    flex-direction: column;
    align-items: stretch;
    gap: 1rem;
  }

  .action-buttons {
    justify-content: center;
  }

  .help-dialog {
    width: 95%;
    max-height: 90vh;
  }

  .help-dialog-header {
    padding: 1.25rem 1.5rem;
  }

  .help-dialog-content {
    padding: 1.5rem;
  }

  .help-option {
    padding: 1rem;
  }

  .custom-question-section {
    padding: 1rem;
  }

  .custom-question-actions {
    flex-direction: column;
  }

  .cancel-custom-button,
  .submit-custom-button {
    width: 100%;
  }

  .confirm-dialog {
    width: 95%;
    padding: 1.5rem;
  }

  .dialog-actions {
    flex-direction: column;
    gap: 0.75rem;
  }

  .cancel-button,
  .confirm-button {
    width: 100%;
  }
}

@media (max-width: 480px) {
  .warning-content {
    flex-direction: column;
    text-align: center;
    gap: 0.75rem;
  }

  .warning-icon {
    font-size: 1.3rem;
  }

  .warning-text {
    font-size: 0.8rem;
  }
}

/* ğŸ”¥ å¿«ç…§é¢„è§ˆåŒºåŸŸ */
.answer-preview {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 2px solid #0ea5e9;
  border-radius: 12px;
  padding: 1rem;
  margin: 1.5rem 0;
  animation: slideIn 0.3s ease-out;
}

.preview-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid rgba(14, 165, 233, 0.2);
}

.preview-icon {
  font-size: 1.2rem;
}

.preview-title {
  font-weight: 600;
  color: #0369a1;
  font-size: 0.95rem;
}

.preview-body {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.preview-textarea {
  width: 100%;
  border: 2px solid #0ea5e9;
  border-radius: 8px;
  padding: 0.75rem;
  font-size: 0.9rem;
  line-height: 1.6;
  color: #334155;
  background: white;
  resize: vertical;
  min-height: 200px;
  font-family: inherit;
  transition: all 0.3s ease;
}

.preview-textarea:focus {
  outline: none;
  border-color: #0284c7;
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

.preview-hint {
  color: #64748b;
  font-size: 0.85rem;
  margin: 0;
  font-style: italic;
}

.char-count {
  text-align: right;
  font-size: 0.8rem;
  color: #94a3b8;
}

/* ç¡®ä¿ç¡®è®¤æŒ‰é’®ç¦ç”¨çŠ¶æ€ */
.confirm-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}
</style>
